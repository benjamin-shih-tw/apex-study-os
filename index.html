<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>APEX STUDY OS</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Noto+Sans+TC:wght@300;400;500;700&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
<style>
  :root {
    --bg-0: #040810;
    --bg-1: #070e1a;
    --bg-2: #0a1628;
    --bg-3: #0d1f3c;
    --panel: rgba(10, 22, 45, 0.85);
    --border: rgba(0, 180, 255, 0.15);
    --border-bright: rgba(0, 180, 255, 0.4);
    --accent: #00b4ff;
    --accent-dim: rgba(0, 180, 255, 0.6);
    --accent-glow: rgba(0, 180, 255, 0.15);
    --cyan: #00e5ff;
    --green: #00ff9d;
    --yellow: #ffd166;
    --red: #ff4d6d;
    --purple: #a855f7;
    --text-pri: #e8f4fd;
    --text-sec: #7ab3d4;
    --text-dim: #3a6080;
    --font-display: 'Orbitron', monospace;
    --font-mono: 'Space Mono', monospace;
    --font-body: 'Noto Sans TC', sans-serif;
    --radius: 4px;
    --radius-lg: 8px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }
  html { scroll-behavior: smooth; }

  body {
    background: var(--bg-0);
    color: var(--text-pri);
    font-family: var(--font-body);
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(0, 180, 255, 0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0, 180, 255, 0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  body::after {
    content: '';
    position: fixed;
    inset: 0;
    background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.05) 2px, rgba(0,0,0,0.05) 4px);
    pointer-events: none;
    z-index: 0;
  }

  /* SYNC STATUS BAR */
  #sync-bar {
    position: fixed;
    top: 0; left: 0; right: 0;
    height: 28px;
    background: var(--bg-1);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding: 0 20px;
    gap: 8px;
    z-index: 200;
    font-family: var(--font-mono);
    font-size: 9px;
    letter-spacing: 1px;
  }

  .sync-dot {
    width: 6px; height: 6px;
    border-radius: 50%;
    background: var(--text-dim);
    transition: background 0.3s;
  }

  .sync-dot.synced { background: var(--green); box-shadow: 0 0 6px var(--green); }
  .sync-dot.syncing { background: var(--yellow); animation: glowPulse 0.8s infinite; }
  .sync-dot.error { background: var(--red); }

  #sync-label { color: var(--text-dim); }

  /* LOGIN SCREEN */
  #login-screen {
    position: fixed;
    inset: 0;
    background: var(--bg-0);
    z-index: 500;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 24px;
  }

  .login-box {
    background: var(--panel);
    border: 1px solid var(--border-bright);
    border-radius: var(--radius-lg);
    padding: 40px;
    width: 360px;
    text-align: center;
    box-shadow: 0 0 60px rgba(0,180,255,0.1);
  }

  .login-title {
    font-family: var(--font-display);
    font-size: 22px;
    font-weight: 900;
    letter-spacing: 4px;
    color: var(--accent);
    text-shadow: 0 0 20px var(--accent);
    margin-bottom: 6px;
  }

  .login-sub {
    font-family: var(--font-mono);
    font-size: 9px;
    color: var(--text-dim);
    letter-spacing: 2px;
    margin-bottom: 32px;
  }

  .btn-google {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    width: 100%;
    padding: 12px;
    background: white;
    border: none;
    border-radius: var(--radius);
    font-family: var(--font-body);
    font-size: 14px;
    font-weight: 500;
    color: #333;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-google:hover { background: #f5f5f5; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }

  .google-icon { font-size: 18px; }

  /* LAYOUT */
  .app-shell {
    display: flex;
    min-height: 100vh;
    position: relative;
    z-index: 1;
    padding-top: 28px;
  }

  /* SIDEBAR */
  .sidebar {
    width: 220px;
    flex-shrink: 0;
    background: var(--bg-1);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    position: fixed;
    top: 28px; left: 0; bottom: 0;
    z-index: 100;
  }

  .sidebar-logo {
    padding: 20px 20px 16px;
    border-bottom: 1px solid var(--border);
  }

  .logo-text {
    font-family: var(--font-display);
    font-size: 13px;
    font-weight: 900;
    letter-spacing: 3px;
    color: var(--accent);
    text-shadow: 0 0 20px var(--accent);
  }

  .logo-sub { font-family: var(--font-mono); font-size: 9px; color: var(--text-dim); letter-spacing: 2px; margin-top: 2px; }

  .user-info {
    padding: 10px 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .user-avatar {
    width: 28px; height: 28px;
    border-radius: 50%;
    border: 1px solid var(--border-bright);
    object-fit: cover;
  }

  .user-name { font-size: 11px; color: var(--text-sec); flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

  .btn-logout {
    background: none;
    border: none;
    color: var(--text-dim);
    font-size: 12px;
    cursor: pointer;
    transition: color 0.2s;
  }

  .btn-logout:hover { color: var(--red); }

  .sidebar-nav { flex: 1; padding: 16px 0; overflow-y: auto; }

  .nav-section-label { font-family: var(--font-mono); font-size: 9px; letter-spacing: 2px; color: var(--text-dim); padding: 8px 20px 4px; text-transform: uppercase; }

  .nav-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 20px;
    cursor: pointer;
    transition: all 0.2s;
    border-left: 2px solid transparent;
    font-size: 13px;
    color: var(--text-sec);
  }

  .nav-item:hover { background: var(--accent-glow); color: var(--accent); border-left-color: var(--accent-dim); }
  .nav-item.active { background: var(--accent-glow); color: var(--accent); border-left-color: var(--accent); }
  .nav-icon { font-size: 14px; width: 18px; text-align: center; }

  /* MAIN */
  .main-content { margin-left: 220px; flex: 1; padding: 28px 32px; min-height: 100vh; }

  .page { display: none; animation: fadeIn 0.3s ease; }
  .page.active { display: block; }

  @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

  .page-header { display: flex; align-items: baseline; gap: 12px; margin-bottom: 28px; padding-bottom: 16px; border-bottom: 1px solid var(--border); }
  .page-title { font-family: var(--font-display); font-size: 18px; font-weight: 700; letter-spacing: 3px; color: var(--text-pri); }
  .page-tag { font-family: var(--font-mono); font-size: 10px; color: var(--accent); letter-spacing: 2px; opacity: 0.7; }

  /* CARDS */
  .card {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: 20px;
    backdrop-filter: blur(10px);
    position: relative;
    overflow: hidden;
  }

  .card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--accent-dim), transparent);
    opacity: 0.5;
  }

  .card-title { font-family: var(--font-mono); font-size: 10px; letter-spacing: 2px; color: var(--text-dim); text-transform: uppercase; margin-bottom: 14px; }

  /* GRIDS */
  .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; }
  .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
  .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
  .grid-main { display: grid; grid-template-columns: 2fr 1fr; gap: 16px; }

  /* STAT CARDS */
  .stat-card { background: var(--panel); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 18px 20px; position: relative; overflow: hidden; }
  .stat-label { font-family: var(--font-mono); font-size: 9px; letter-spacing: 2px; color: var(--text-dim); text-transform: uppercase; margin-bottom: 6px; }
  .stat-value { font-family: var(--font-display); font-size: 28px; font-weight: 700; color: var(--accent); text-shadow: 0 0 15px var(--accent-dim); line-height: 1; }
  .stat-unit { font-family: var(--font-mono); font-size: 11px; color: var(--text-sec); margin-top: 4px; }
  .stat-accent-green .stat-value { color: var(--green); text-shadow: 0 0 15px rgba(0,255,157,0.4); }
  .stat-accent-yellow .stat-value { color: var(--yellow); text-shadow: 0 0 15px rgba(255,209,102,0.4); }
  .stat-accent-red .stat-value { color: var(--red); text-shadow: 0 0 15px rgba(255,77,109,0.4); }

  /* BUTTONS */
  .btn { font-family: var(--font-mono); font-size: 11px; letter-spacing: 1px; padding: 8px 16px; border-radius: var(--radius); cursor: pointer; transition: all 0.2s; border: 1px solid; text-transform: uppercase; }
  .btn-primary { background: var(--accent); border-color: var(--accent); color: var(--bg-0); font-weight: 700; }
  .btn-primary:hover { background: var(--cyan); border-color: var(--cyan); box-shadow: 0 0 20px var(--accent-dim); }
  .btn-ghost { background: transparent; border-color: var(--border-bright); color: var(--accent); }
  .btn-ghost:hover { background: var(--accent-glow); border-color: var(--accent); }
  .btn-danger { background: transparent; border-color: rgba(255,77,109,0.4); color: var(--red); }
  .btn-danger:hover { background: rgba(255,77,109,0.1); }
  .btn-sm { padding: 5px 10px; font-size: 9px; }

  /* FORMS */
  .form-group { margin-bottom: 14px; }
  .form-label { display: block; font-family: var(--font-mono); font-size: 9px; letter-spacing: 2px; color: var(--text-dim); text-transform: uppercase; margin-bottom: 6px; }
  .form-input, .form-select, .form-textarea { width: 100%; background: var(--bg-2); border: 1px solid var(--border); border-radius: var(--radius); padding: 9px 12px; color: var(--text-pri); font-family: var(--font-body); font-size: 13px; transition: border-color 0.2s; outline: none; }
  .form-input:focus, .form-select:focus, .form-textarea:focus { border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent-glow); }
  .form-textarea { resize: vertical; min-height: 80px; }
  .form-select option { background: var(--bg-2); }

  /* TAGS */
  .tag { display: inline-block; font-family: var(--font-mono); font-size: 9px; letter-spacing: 1px; padding: 2px 8px; border-radius: 2px; text-transform: uppercase; border: 1px solid; }
  .tag-physics { color: #00e5ff; border-color: rgba(0,229,255,0.3); background: rgba(0,229,255,0.08); }
  .tag-chem { color: #a855f7; border-color: rgba(168,85,247,0.3); background: rgba(168,85,247,0.08); }
  .tag-bio { color: #00ff9d; border-color: rgba(0,255,157,0.3); background: rgba(0,255,157,0.08); }
  .tag-math { color: #ffd166; border-color: rgba(255,209,102,0.3); background: rgba(255,209,102,0.08); }
  .tag-geo { color: #ff9f43; border-color: rgba(255,159,67,0.3); background: rgba(255,159,67,0.08); }
  .tag-eng { color: #ff4d6d; border-color: rgba(255,77,109,0.3); background: rgba(255,77,109,0.08); }
  .tag-chi { color: #4cc9f0; border-color: rgba(76,201,240,0.3); background: rgba(76,201,240,0.08); }
  .tag-red { color: var(--red); border-color: rgba(255,77,109,0.3); background: rgba(255,77,109,0.08); }
  .tag-yellow { color: var(--yellow); border-color: rgba(255,209,102,0.3); background: rgba(255,209,102,0.08); }
  .tag-green { color: var(--green); border-color: rgba(0,255,157,0.3); background: rgba(0,255,157,0.08); }

  /* TABLE */
  .data-table { width: 100%; border-collapse: collapse; }
  .data-table th { font-family: var(--font-mono); font-size: 9px; letter-spacing: 2px; color: var(--text-dim); text-transform: uppercase; padding: 10px 14px; text-align: left; border-bottom: 1px solid var(--border); }
  .data-table td { padding: 12px 14px; font-size: 13px; border-bottom: 1px solid rgba(0,180,255,0.06); vertical-align: top; }
  .data-table tr:hover td { background: var(--accent-glow); }

  /* MODAL */
  .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(4, 8, 16, 0.85); backdrop-filter: blur(4px); z-index: 1000; align-items: center; justify-content: center; }
  .modal-overlay.open { display: flex; }
  .modal { background: var(--bg-1); border: 1px solid var(--border-bright); border-radius: var(--radius-lg); padding: 28px; width: 520px; max-width: 95vw; max-height: 85vh; overflow-y: auto; position: relative; box-shadow: 0 0 60px rgba(0,180,255,0.1); }
  .modal-title { font-family: var(--font-display); font-size: 14px; letter-spacing: 2px; color: var(--accent); margin-bottom: 20px; }
  .modal-close { position: absolute; top: 16px; right: 16px; background: none; border: none; color: var(--text-dim); font-size: 18px; cursor: pointer; transition: color 0.2s; }
  .modal-close:hover { color: var(--red); }

  /* TODO */
  .todo-item { display: flex; align-items: center; gap: 10px; padding: 8px 10px; border-radius: var(--radius); transition: background 0.15s; }
  .todo-item:hover { background: var(--accent-glow); }
  .todo-checkbox { width: 16px; height: 16px; border: 1px solid var(--border-bright); border-radius: 2px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; transition: all 0.2s; cursor: pointer; }
  .todo-checkbox.checked { background: var(--accent); border-color: var(--accent); box-shadow: 0 0 8px var(--accent-dim); }
  .todo-checkbox.checked::after { content: 'âœ“'; color: var(--bg-0); font-size: 10px; font-weight: 700; }
  .todo-text { font-size: 13px; flex: 1; }
  .todo-text.done { text-decoration: line-through; color: var(--text-dim); }

  /* TIMER */
  .timer-display { font-family: var(--font-display); font-size: 56px; font-weight: 900; text-align: center; padding: 24px 0; letter-spacing: 6px; color: var(--accent); text-shadow: 0 0 40px var(--accent), 0 0 80px rgba(0,180,255,0.2); transition: color 0.3s; }
  .timer-display.running { color: var(--green); text-shadow: 0 0 40px var(--green), 0 0 80px rgba(0,255,157,0.2); }
  .timer-controls { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; }

  /* CHAPTER */
  .chapter-subject-section { margin-bottom: 20px; }
  .chapter-subject-header { display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; background: var(--bg-2); border: 1px solid var(--border); border-radius: var(--radius); cursor: pointer; transition: all 0.2s; margin-bottom: 8px; }
  .chapter-subject-header:hover { border-color: var(--accent-dim); }
  .chapter-subject-name { font-family: var(--font-display); font-size: 12px; letter-spacing: 2px; }
  .chapter-list { display: none; padding-left: 12px; }
  .chapter-list.open { display: block; }
  .chapter-item { display: flex; align-items: center; gap: 10px; padding: 8px 12px; border-radius: var(--radius); transition: background 0.15s; }
  .chapter-item:hover { background: var(--accent-glow); }
  .chapter-status { width: 20px; height: 20px; border: 1px solid var(--border-bright); border-radius: 50%; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 9px; cursor: pointer; transition: all 0.2s; }
  .chapter-status.not-started { color: var(--text-dim); }
  .chapter-status.fuzzy { background: rgba(255,209,102,0.15); border-color: var(--yellow); color: var(--yellow); }
  .chapter-status.mastered { background: rgba(0,255,157,0.15); border-color: var(--green); color: var(--green); }
  .chapter-name { font-size: 13px; flex: 1; }
  .chapter-add-btn { background: none; border: 1px dashed var(--border); color: var(--text-dim); font-family: var(--font-mono); font-size: 10px; padding: 6px 12px; border-radius: var(--radius); cursor: pointer; width: 100%; transition: all 0.2s; text-align: left; margin-top: 4px; }
  .chapter-add-btn:hover { border-color: var(--accent-dim); color: var(--accent); }

  /* NOTES */
  .notes-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 16px; }
  .note-card { background: var(--bg-2); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 16px; cursor: pointer; transition: all 0.2s; }
  .note-card:hover { border-color: var(--accent-dim); box-shadow: 0 0 20px rgba(0,180,255,0.08); }
  .note-card-title { font-size: 14px; font-weight: 500; margin-bottom: 6px; }
  .note-card-meta { font-family: var(--font-mono); font-size: 9px; color: var(--text-dim); letter-spacing: 1px; margin-bottom: 10px; }
  .note-card-preview { font-size: 12px; color: var(--text-sec); line-height: 1.6; }
  .note-image-thumb { width: 100%; max-height: 160px; object-fit: cover; border-radius: var(--radius); margin-top: 10px; border: 1px solid var(--border); }
  .note-detail { display: none; }
  .note-detail.open { display: block; }
  .note-list-view.hidden { display: none; }

  /* WRONG Q */
  .wrongq-card { background: var(--bg-2); border: 1px solid var(--border); border-left: 3px solid var(--red); border-radius: var(--radius-lg); padding: 18px; margin-bottom: 14px; transition: all 0.2s; }
  .wrongq-card:hover { border-color: rgba(255,77,109,0.4); box-shadow: 0 4px 24px rgba(255,77,109,0.06); }
  .wrongq-card.mastered { border-left-color: var(--green); opacity: 0.55; }
  .wrongq-header { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
  .wrongq-question { font-size: 14px; line-height: 1.7; margin-bottom: 10px; color: var(--text-pri); }
  .wrongq-img { width: 100%; max-height: 220px; object-fit: contain; border-radius: var(--radius); margin: 10px 0; border: 1px solid var(--border); background: var(--bg-3); cursor: pointer; }
  .wrongq-reason { margin-top: 8px; padding: 10px 14px; background: rgba(255,77,109,0.06); border-radius: var(--radius); font-size: 12px; color: var(--text-sec); border-left: 2px solid rgba(255,77,109,0.35); }
  .wrongq-solution { margin-top: 8px; padding: 10px 14px; background: rgba(0,255,157,0.05); border-radius: var(--radius); font-size: 12px; color: var(--text-sec); border-left: 2px solid rgba(0,255,157,0.35); }
  .wrongq-actions { display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap; }

  /* WRONG Q STATS */
  .wq-stats-grid { display: grid; grid-template-columns: repeat(4,1fr); gap: 12px; margin-bottom: 20px; }
  .wq-stat { background: var(--bg-2); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 14px 16px; }
  .wq-stat-label { font-family: var(--font-mono); font-size: 9px; letter-spacing: 2px; color: var(--text-dim); text-transform: uppercase; margin-bottom: 6px; }
  .wq-stat-value { font-family: var(--font-display); font-size: 22px; font-weight: 700; color: var(--accent); text-shadow: 0 0 12px var(--accent-dim); }

  /* STAR RATING */
  .star-row { display: flex; gap: 6px; align-items: center; }
  .star { font-size: 18px; cursor: pointer; color: var(--text-dim); transition: color 0.15s, transform 0.15s; }
  .star:hover, .star.active { color: var(--yellow); transform: scale(1.2); }

  /* ERROR TYPE CHIPS */
  .error-type-row { display: flex; gap: 8px; flex-wrap: wrap; }
  .error-chip { padding: 5px 12px; border-radius: 20px; font-size: 11px; font-family: var(--font-mono); letter-spacing: 1px; cursor: pointer; border: 1px solid var(--border); color: var(--text-sec); background: transparent; transition: all 0.15s; }
  .error-chip:hover { border-color: var(--accent-dim); color: var(--accent); }
  .error-chip.selected-careless { background: rgba(255,209,102,0.15); border-color: var(--yellow); color: var(--yellow); }
  .error-chip.selected-concept  { background: rgba(255,77,109,0.15); border-color: var(--red); color: var(--red); }
  .error-chip.selected-formula  { background: rgba(168,85,247,0.15); border-color: var(--purple); color: var(--purple); }
  .error-chip.selected-calc     { background: rgba(0,229,255,0.15); border-color: var(--cyan); color: var(--cyan); }
  .error-chip.selected-reading  { background: rgba(255,159,67,0.15); border-color: #ff9f43; color: #ff9f43; }
  .error-chip.selected-other    { background: rgba(122,179,212,0.15); border-color: var(--text-sec); color: var(--text-sec); }

  /* REVIEW COUNTDOWN */
  .review-badge { display: inline-flex; align-items: center; gap: 4px; font-family: var(--font-mono); font-size: 9px; padding: 2px 8px; border-radius: 10px; border: 1px solid; }
  .review-due  { color: var(--red);    border-color: rgba(255,77,109,0.4);   background: rgba(255,77,109,0.08);   animation: glowPulse 2s infinite; }
  .review-soon { color: var(--yellow); border-color: rgba(255,209,102,0.4);  background: rgba(255,209,102,0.08); }
  .review-ok   { color: var(--green);  border-color: rgba(0,255,157,0.4);    background: rgba(0,255,157,0.08); }

  /* INTERACTIVE HOVER BUTTON */
  .ihb { position: relative; overflow: hidden; border-radius: 999px; border: 1px solid var(--border-bright); background: transparent; padding: 8px 20px; font-family: var(--font-mono); font-size: 10px; letter-spacing: 1px; cursor: pointer; color: var(--accent); text-transform: uppercase; white-space: nowrap; }
  .ihb-text { display: inline-block; transition: transform 0.3s, opacity 0.3s; }
  .ihb:hover .ihb-text { transform: translateX(40px); opacity: 0; }
  .ihb-hover-content { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; gap: 6px; transform: translateX(-40px); opacity: 0; transition: transform 0.3s, opacity 0.3s; color: var(--bg-0); font-weight: 700; z-index: 2; font-family: var(--font-mono); font-size: 10px; letter-spacing: 1px; text-transform: uppercase; }
  .ihb:hover .ihb-hover-content { transform: translateX(0); opacity: 1; }
  .ihb-bg { position: absolute; left: 20%; top: 40%; width: 8px; height: 8px; border-radius: 999px; background: var(--accent); transition: all 0.35s cubic-bezier(0.4,0,0.2,1); z-index: 1; }
  .ihb:hover .ihb-bg { left: 0; top: 0; width: 100%; height: 100%; border-radius: 0; }
  .ihb-danger { border-color: rgba(255,77,109,0.4); color: var(--red); }
  .ihb-danger .ihb-bg { background: var(--red); }
  .ihb-green { border-color: rgba(0,255,157,0.4); color: var(--green); }
  .ihb-green .ihb-bg { background: var(--green); }

  /* IMAGE LIGHTBOX */
  .lightbox { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.92); z-index: 2000; align-items: center; justify-content: center; cursor: zoom-out; }
  .lightbox.open { display: flex; }
  .lightbox img { max-width: 90vw; max-height: 90vh; border-radius: var(--radius); }

  /* SUBJECT ROW */
  .subject-row { display: flex; align-items: center; gap: 12px; padding: 10px 0; border-bottom: 1px solid rgba(0,180,255,0.06); }
  .subject-row:last-child { border-bottom: none; }
  .subject-name { width: 40px; font-family: var(--font-mono); font-size: 10px; letter-spacing: 1px; color: var(--text-sec); flex-shrink: 0; }
  .subject-bar-wrap { flex: 1; background: var(--bg-3); border-radius: 2px; height: 6px; overflow: hidden; }
  .subject-bar-fill { height: 100%; border-radius: 2px; transition: width 0.5s ease; }
  .subject-pct { width: 36px; font-family: var(--font-display); font-size: 11px; color: var(--text-sec); text-align: right; flex-shrink: 0; }

  /* MISC */
  .divider { height: 1px; background: var(--border); margin: 20px 0; }
  .mt-4 { margin-top: 16px; }
  .mb-4 { margin-bottom: 16px; }
  .flex-between { display: flex; justify-content: space-between; align-items: center; }
  .flex-gap { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
  .legend { display: flex; gap: 16px; flex-wrap: wrap; margin-bottom: 12px; }
  .legend-item { display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--text-sec); }
  .legend-dot { width: 10px; height: 10px; border-radius: 50%; }
  .empty-state { text-align: center; padding: 48px 20px; color: var(--text-dim); }
  .empty-icon { font-size: 32px; margin-bottom: 12px; }
  .empty-text { font-family: var(--font-mono); font-size: 11px; letter-spacing: 2px; }
  input[type="file"] { display: none; }

  @keyframes glowPulse { 0%, 100% { opacity: 0.6; } 50% { opacity: 1; } }

  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: var(--bg-1); }
  ::-webkit-scrollbar-thumb { background: var(--bg-3); border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--accent-dim); }
</style>
</head>
<body>

<!-- SYNC BAR -->
<div id="sync-bar">
  <div class="sync-dot" id="sync-dot"></div>
  <span id="sync-label">Not connected</span>
</div>

<!-- LOGIN SCREEN -->
<div id="login-screen">
  <div class="login-box">
    <div class="login-title">APEX</div>
    <div class="login-sub">STUDY OS v2.0 Â· CLOUD SYNC</div>
    <button class="btn-google" onclick="signInWithGoogle()">
      <span class="google-icon">G</span>
      ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥
    </button>
    <div style="margin-top:16px;font-family:var(--font-mono);font-size:9px;color:var(--text-dim);">è³‡æ–™åŠ å¯†å­˜æ–¼ Firebase Â· è·¨è£ç½®åŒæ­¥</div>
  </div>
</div>

<div class="app-shell" id="app-shell" style="display:none;">

  <!-- SIDEBAR -->
  <nav class="sidebar">
    <div class="sidebar-logo">
      <div class="logo-text">APEX</div>
      <div class="logo-sub">STUDY OS v2.0</div>
    </div>
    <div class="user-info">
      <img id="user-avatar" class="user-avatar" src="" alt="">
      <span id="user-name" class="user-name"></span>
      <button class="btn-logout" onclick="signOut()" title="ç™»å‡º">â»</button>
    </div>
    <div class="sidebar-nav">
      <div class="nav-section-label">Main</div>
      <div class="nav-item active" onclick="showPage('dashboard')"><span class="nav-icon">âŠ</span> Dashboard</div>
      <div class="nav-item" onclick="showPage('timer')"><span class="nav-icon">â—·</span> Study Timer</div>
      <div class="nav-section-label" style="margin-top:8px;">Academics</div>
      <div class="nav-item" onclick="showPage('progress')"><span class="nav-icon">â—ˆ</span> ç« ç¯€é€²åº¦</div>
      <div class="nav-item" onclick="showPage('notes')"><span class="nav-icon">â—»</span> ç­†è¨˜æœ¬</div>
      <div class="nav-item" onclick="showPage('wrongq')"><span class="nav-icon">âš </span> éŒ¯é¡Œæœ¬</div>
      <div class="nav-section-label" style="margin-top:8px;">Exams</div>
      <div class="nav-item" onclick="showPage('exams')"><span class="nav-icon">â—†</span> è€ƒè©¦å€’æ•¸</div>
    </div>
  </nav>

  <!-- MAIN -->
  <main class="main-content">

    <!-- DASHBOARD -->
    <div id="page-dashboard" class="page active">
      <div class="page-header">
        <div class="page-title">DASHBOARD</div>
        <div class="page-tag" id="today-date-label"></div>
      </div>
      <div class="grid-4 mb-4">
        <div class="stat-card stat-accent-green">
          <div class="stat-label">Today Study</div>
          <div class="stat-value" id="dash-study-time">0</div>
          <div class="stat-unit">åˆ†é˜</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Next Exam</div>
          <div class="stat-value" id="dash-next-exam">--</div>
          <div class="stat-unit" id="dash-next-exam-name">å°šæœªè¨­å®š</div>
        </div>
        <div class="stat-card stat-accent-red">
          <div class="stat-label">Wrong Q</div>
          <div class="stat-value" id="dash-wrong-count">0</div>
          <div class="stat-unit">é¡Œå¾…è¤‡ç¿’</div>
        </div>
        <div class="stat-card stat-accent-yellow">
          <div class="stat-label">Overall Progress</div>
          <div class="stat-value" id="dash-overall-pct">0%</div>
          <div class="stat-unit">ç« ç¯€æŒæ¡ç‡</div>
        </div>
      </div>
      <div class="grid-main">
        <div class="card">
          <div class="flex-between mb-4">
            <div class="card-title">Today's Tasks</div>
            <button class="btn btn-ghost btn-sm" onclick="openAddTodo()">+ Add</button>
          </div>
          <div id="todo-list"></div>
          <div class="empty-state" id="todo-empty" style="display:none;"><div class="empty-icon">â—»</div><div class="empty-text">No tasks yet</div></div>
        </div>
        <div class="card">
          <div class="card-title">Subject Overview</div>
          <div id="dash-subject-overview"></div>
        </div>
      </div>
    </div>

    <!-- TIMER -->
    <div id="page-timer" class="page">
      <div class="page-header"><div class="page-title">STUDY TIMER</div><div class="page-tag">Focus Mode</div></div>
      <div class="grid-2">
        <div class="card">
          <div class="card-title">Session Timer</div>
          <div class="timer-display" id="timer-display">00:00:00</div>
          <div class="timer-controls">
            <button class="btn btn-primary" onclick="timerStart()">â–¶ START</button>
            <button class="btn btn-ghost" onclick="timerPause()">â¸ PAUSE</button>
            <button class="btn btn-danger" onclick="timerReset()">â†º RESET</button>
          </div>
          <div class="mt-4">
            <div class="form-group">
              <label class="form-label">ç§‘ç›®</label>
              <select class="form-select" id="timer-subject">
                <option value="physics">ç‰©ç†</option><option value="chem">åŒ–å­¸</option><option value="bio">ç”Ÿç‰©</option>
                <option value="math">æ•¸å­¸</option><option value="geo">åœ°ç†</option><option value="eng">è‹±æ–‡</option><option value="chi">åœ‹æ–‡</option>
              </select>
            </div>
            <button class="btn btn-primary" onclick="saveSession()" style="width:100%;">âœ“ Log Session</button>
          </div>
        </div>
        <div class="card">
          <div class="card-title">Today's Log</div>
          <div id="session-log"></div>
          <div class="empty-state" id="session-empty"><div class="empty-icon">â—·</div><div class="empty-text">No sessions logged</div></div>
        </div>
      </div>
    </div>

    <!-- PROGRESS -->
    <div id="page-progress" class="page">
      <div class="page-header"><div class="page-title">ç« ç¯€é€²åº¦</div><div class="page-tag">Chapter Tracker</div></div>
      <div class="legend">
        <div class="legend-item"><div class="legend-dot" style="background:var(--text-dim);border:1px solid var(--border-bright);"></div> æœªé–‹å§‹</div>
        <div class="legend-item"><div class="legend-dot" style="background:var(--yellow);"></div> æ¨¡ç³Š / è®€é</div>
        <div class="legend-item"><div class="legend-dot" style="background:var(--green);"></div> æŒæ¡</div>
      </div>
      <div class="flex-gap mb-4"><button class="btn btn-primary" onclick="openAddChapter()">+ æ–°å¢ç« ç¯€</button></div>
      <div id="chapter-tree"></div>
    </div>

    <!-- NOTES -->
    <div id="page-notes" class="page">
      <div class="page-header"><div class="page-title">ç­†è¨˜æœ¬</div><div class="page-tag">Notes</div></div>
      <div class="note-list-view" id="notes-list-view">
        <div class="flex-gap mb-4">
          <button class="btn btn-primary" onclick="openAddNote()">+ æ–°å¢ç­†è¨˜</button>
          <select class="form-select" style="width:140px;" id="notes-filter" onchange="renderNotes()">
            <option value="all">å…¨éƒ¨ç§‘ç›®</option>
            <option value="physics">ç‰©ç†</option><option value="chem">åŒ–å­¸</option><option value="bio">ç”Ÿç‰©</option>
            <option value="math">æ•¸å­¸</option><option value="geo">åœ°ç†</option><option value="eng">è‹±æ–‡</option><option value="chi">åœ‹æ–‡</option>
          </select>
        </div>
        <div class="notes-grid" id="notes-grid"></div>
        <div class="empty-state" id="notes-empty" style="display:none;"><div class="empty-icon">â—»</div><div class="empty-text">No notes yet</div></div>
      </div>
      <div class="note-detail" id="note-detail-view">
        <button class="btn btn-ghost btn-sm" onclick="closeNoteDetail()" style="margin-bottom:16px;">â† Back</button>
        <div class="card">
          <div class="flex-between mb-4">
            <div>
              <div id="note-detail-title" style="font-size:18px;font-weight:500;margin-bottom:6px;"></div>
              <div id="note-detail-meta" class="page-tag"></div>
            </div>
            <button class="btn btn-danger btn-sm" onclick="deleteCurrentNote()">Delete</button>
          </div>
          <div id="note-detail-tags" class="flex-gap mb-4"></div>
          <img id="note-detail-img" class="note-image-thumb" style="display:none;" alt="">
          <div class="divider"></div>
          <div id="note-detail-summary" style="font-size:14px;line-height:1.8;white-space:pre-wrap;"></div>
          <div id="note-detail-questions" style="margin-top:16px;"></div>
        </div>
      </div>
    </div>

    <!-- WRONG Q -->
    <div id="page-wrongq" class="page">
      <div class="page-header"><div class="page-title">éŒ¯é¡Œæœ¬</div><div class="page-tag">Wrong Answer Bank</div></div>

      <!-- Stats -->
      <div class="wq-stats-grid" id="wq-stats"></div>

      <!-- Filters -->
      <div class="flex-gap mb-4" style="flex-wrap:wrap;">
        <button class="ihb ihb-primary" onclick="openAddWrongQ()"><div class="ihb-bg"></div><span class="ihb-text">+ æ–°å¢éŒ¯é¡Œ</span><div class="ihb-hover-content">+ æ–°å¢éŒ¯é¡Œ â†’</div></button>
        <select class="form-select" style="width:130px;" id="wrongq-filter" onchange="renderWrongQ()">
          <option value="all">å…¨éƒ¨ç§‘ç›®</option>
          <option value="physics">ç‰©ç†</option><option value="chem">åŒ–å­¸</option><option value="bio">ç”Ÿç‰©</option>
          <option value="math">æ•¸å­¸</option><option value="geo">åœ°ç†</option><option value="eng">è‹±æ–‡</option><option value="chi">åœ‹æ–‡</option>
        </select>
        <select class="form-select" style="width:130px;" id="wrongq-type-filter" onchange="renderWrongQ()">
          <option value="all">å…¨éƒ¨é¡å‹</option>
          <option value="careless">ç²—å¿ƒ</option><option value="concept">è§€å¿µéŒ¯èª¤</option>
          <option value="formula">å…¬å¼è¨˜éŒ¯</option><option value="calc">å°è¨ˆç®—éŒ¯</option>
          <option value="reading">é¡Œæ„çœ‹éŒ¯</option><option value="other">å…¶ä»–</option>
        </select>
        <select class="form-select" style="width:130px;" id="wrongq-difficulty-filter" onchange="renderWrongQ()">
          <option value="all">å…¨éƒ¨é›£åº¦</option>
          <option value="1">â˜… 1æ˜Ÿ</option><option value="2">â˜…â˜… 2æ˜Ÿ</option><option value="3">â˜…â˜…â˜… 3æ˜Ÿ</option>
          <option value="4">â˜…â˜…â˜…â˜… 4æ˜Ÿ</option><option value="5">â˜…â˜…â˜…â˜…â˜… 5æ˜Ÿ</option>
        </select>
        <select class="form-select" style="width:130px;" id="wrongq-status-filter" onchange="renderWrongQ()">
          <option value="all">å…¨éƒ¨ç‹€æ…‹</option><option value="pending">å¾…è¤‡ç¿’</option><option value="due">ä»Šæ—¥åˆ°æœŸ</option><option value="mastered">å·²æŒæ¡</option>
        </select>
      </div>

      <div id="wrongq-list"></div>
      <div class="empty-state" id="wrongq-empty" style="display:none;"><div class="empty-icon">âš </div><div class="empty-text">No wrong answers logged â€” great job!</div></div>
    </div>

    <!-- EXAMS -->
    <div id="page-exams" class="page">
      <div class="page-header"><div class="page-title">è€ƒè©¦å€’æ•¸</div><div class="page-tag">Exam Countdown</div></div>
      <div class="grid-2">
        <div class="card">
          <div class="card-title">Add Exam</div>
          <div class="form-group"><label class="form-label">è€ƒè©¦åç¨±</label><input class="form-input" id="exam-name-input" placeholder="e.g. æœŸä¸­è€ƒ"></div>
          <div class="form-group"><label class="form-label">è€ƒè©¦æ—¥æœŸ</label><input class="form-input" type="date" id="exam-date-input"></div>
          <div class="form-group"><label class="form-label">ç§‘ç›®ç¯„åœï¼ˆé¸å¡«ï¼‰</label><input class="form-input" id="exam-scope-input" placeholder="e.g. ç‰©ç† CH1â€“3"></div>
          <button class="btn btn-primary" onclick="addExam()" style="width:100%;">+ Add Exam</button>
        </div>
        <div class="card">
          <div class="card-title">Upcoming Exams</div>
          <div id="exam-list"></div>
          <div class="empty-state" id="exam-empty" style="display:none;"><div class="empty-icon">â—†</div><div class="empty-text">No exams scheduled</div></div>
        </div>
      </div>
    </div>

  </main>
</div>

<!-- MODALS -->
<div class="modal-overlay" id="modal-todo">
  <div class="modal">
    <div class="modal-title">Add Task</div>
    <button class="modal-close" onclick="closeModal('modal-todo')">âœ•</button>
    <div class="form-group"><label class="form-label">ä»»å‹™å…§å®¹</label><input class="form-input" id="todo-input" placeholder="e.g. ç‰©ç† CH3 ä¾‹é¡Œç·´ç¿’" onkeydown="if(event.key==='Enter')addTodo()"></div>
    <div class="form-group">
      <label class="form-label">ç§‘ç›®ï¼ˆé¸å¡«ï¼‰</label>
      <select class="form-select" id="todo-subject-input">
        <option value="">ç„¡</option>
        <option value="physics">ç‰©ç†</option><option value="chem">åŒ–å­¸</option><option value="bio">ç”Ÿç‰©</option>
        <option value="math">æ•¸å­¸</option><option value="geo">åœ°ç†</option><option value="eng">è‹±æ–‡</option><option value="chi">åœ‹æ–‡</option>
      </select>
    </div>
    <div class="flex-gap"><button class="btn btn-primary" onclick="addTodo()">Add</button><button class="btn btn-ghost" onclick="closeModal('modal-todo')">Cancel</button></div>
  </div>
</div>

<div class="modal-overlay" id="modal-note">
  <div class="modal">
    <div class="modal-title">New Note</div>
    <button class="modal-close" onclick="closeModal('modal-note')">âœ•</button>
    <div class="form-group"><label class="form-label">æ¨™é¡Œ</label><input class="form-input" id="note-title-input" placeholder="e.g. ç‰©ç† CH3 ç‰›é “ç¬¬äºŒå®šå¾‹"></div>
    <div class="grid-2">
      <div class="form-group">
        <label class="form-label">ç§‘ç›®</label>
        <select class="form-select" id="note-subject-input">
          <option value="physics">ç‰©ç†</option><option value="chem">åŒ–å­¸</option><option value="bio">ç”Ÿç‰©</option>
          <option value="math">æ•¸å­¸</option><option value="geo">åœ°ç†</option><option value="eng">è‹±æ–‡</option><option value="chi">åœ‹æ–‡</option>
        </select>
      </div>
      <div class="form-group"><label class="form-label">ç« ç¯€</label><input class="form-input" id="note-chapter-input" placeholder="e.g. CH3"></div>
    </div>
    <div class="form-group"><label class="form-label">é‡é»æ‘˜è¦</label><textarea class="form-textarea" id="note-summary-input" placeholder="è¨˜éŒ„é€™å ‚èª²çš„é‡é»æ¦‚å¿µ..."></textarea></div>
    <div class="form-group"><label class="form-label">ä¸æ‡‚çš„å•é¡Œ</label><textarea class="form-textarea" id="note-questions-input" placeholder="ä»Šå¤©é‚„ä¸æ¸…æ¥šçš„åœ°æ–¹...ï¼ˆä¸€è¡Œä¸€å€‹å•é¡Œï¼‰" style="min-height:60px;"></textarea></div>
    <div class="form-group">
      <label class="form-label">æ‰‹å¯«ç­†è¨˜ç…§ç‰‡</label>
      <label class="btn btn-ghost" style="display:inline-block;cursor:pointer;">ğŸ“· é¸æ“‡åœ–ç‰‡<input type="file" accept="image/*" onchange="handleNoteImage(this)"></label>
      <div id="note-img-preview" style="margin-top:8px;"></div>
    </div>
    <div class="flex-gap"><button class="btn btn-primary" onclick="addNote()">Save Note</button><button class="btn btn-ghost" onclick="closeModal('modal-note')">Cancel</button></div>
  </div>
</div>

<div class="modal-overlay" id="modal-wrongq">
  <div class="modal" style="width:600px;">
    <div class="modal-title">Log Wrong Answer</div>
    <button class="modal-close" onclick="closeModal('modal-wrongq')">âœ•</button>

    <div class="grid-2">
      <div class="form-group">
        <label class="form-label">ç§‘ç›®</label>
        <select class="form-select" id="wq-subject-input">
          <option value="physics">ç‰©ç†</option><option value="chem">åŒ–å­¸</option><option value="bio">ç”Ÿç‰©</option>
          <option value="math">æ•¸å­¸</option><option value="geo">åœ°ç†</option><option value="eng">è‹±æ–‡</option><option value="chi">åœ‹æ–‡</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">ä¾†æº</label>
        <select class="form-select" id="wq-source-input">
          <option value="èª²æœ¬ä¾‹é¡Œ">èª²æœ¬ä¾‹é¡Œ</option><option value="å­¸æ ¡è€ƒå·">å­¸æ ¡è€ƒå·</option>
          <option value="åƒè€ƒæ›¸/è¬›ç¾©">åƒè€ƒæ›¸/è¬›ç¾©</option><option value="ç¶²è·¯é¡Œåº«">ç¶²è·¯é¡Œåº«</option><option value="æ¨¡æ“¬è€ƒ">æ¨¡æ“¬è€ƒ</option>
        </select>
      </div>
    </div>

    <div class="form-group">
      <label class="form-label">ç« ç¯€ï¼ˆé¸å¡«ï¼‰</label>
      <input class="form-input" id="wq-chapter-input" placeholder="e.g. CH3">
    </div>

    <div class="form-group">
      <label class="form-label">éŒ¯èª¤é¡å‹</label>
      <div class="error-type-row" id="wq-error-type-row">
        <div class="error-chip" data-type="careless" onclick="selectErrorType('careless')">ğŸ˜µ ç²—å¿ƒ</div>
        <div class="error-chip" data-type="concept"  onclick="selectErrorType('concept')">ğŸ§  è§€å¿µéŒ¯èª¤</div>
        <div class="error-chip" data-type="formula"  onclick="selectErrorType('formula')">ğŸ“ å…¬å¼è¨˜éŒ¯</div>
        <div class="error-chip" data-type="calc"     onclick="selectErrorType('calc')">ğŸ”¢ å°è¨ˆç®—éŒ¯</div>
        <div class="error-chip" data-type="reading"  onclick="selectErrorType('reading')">ğŸ“– é¡Œæ„çœ‹éŒ¯</div>
        <div class="error-chip" data-type="other"    onclick="selectErrorType('other')">â“ å…¶ä»–</div>
      </div>
    </div>

    <div class="form-group">
      <label class="form-label">é›£åº¦</label>
      <div class="star-row" id="wq-star-row">
        <span class="star" data-star="1" onclick="selectStar(1)">â˜…</span>
        <span class="star" data-star="2" onclick="selectStar(2)">â˜…</span>
        <span class="star" data-star="3" onclick="selectStar(3)">â˜…</span>
        <span class="star" data-star="4" onclick="selectStar(4)">â˜…</span>
        <span class="star" data-star="5" onclick="selectStar(5)">â˜…</span>
        <span style="font-family:var(--font-mono);font-size:9px;color:var(--text-dim);margin-left:8px;" id="wq-star-label">æœªé¸æ“‡</span>
      </div>
    </div>

    <div class="form-group"><label class="form-label">é¡Œç›®æè¿°</label><textarea class="form-textarea" id="wq-question-input" placeholder="ç°¡è¿°é¡Œç›®å…§å®¹æˆ–è²¼ä¸Šé¡Œè™Ÿ..."></textarea></div>

    <div class="form-group">
      <label class="form-label">é¡Œç›®ç…§ç‰‡ï¼ˆå¯é¸ï¼‰</label>
      <label class="btn btn-ghost btn-sm" style="display:inline-block;cursor:pointer;border-radius:999px;">
        ğŸ“· ä¸Šå‚³ç…§ç‰‡
        <input type="file" accept="image/*" onchange="handleWQImage(this)">
      </label>
      <div id="wq-img-preview" style="margin-top:8px;"></div>
    </div>

    <div class="form-group"><label class="form-label">âŒ éŒ¯èª¤åŸå› </label><textarea class="form-textarea" id="wq-reason-input" placeholder="æˆ‘ç‚ºä»€éº¼ç­”éŒ¯ï¼Ÿç²—å¿ƒã€è§€å¿µä¸æ¸…ã€å…¬å¼è¨˜éŒ¯..."></textarea></div>
    <div class="form-group"><label class="form-label">âœ… æ­£ç¢ºè§£æ³• / è§€å¿µ</label><textarea class="form-textarea" id="wq-solution-input" placeholder="æ­£ç¢ºçš„è§£é¡Œæ€è·¯æ˜¯..."></textarea></div>

    <div class="form-group">
      <label class="form-label">ä¸‹æ¬¡è¤‡ç¿’æ—¥æœŸ</label>
      <input class="form-input" type="date" id="wq-review-date-input">
      <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;">
        <button class="btn btn-ghost btn-sm" style="border-radius:999px;" onclick="setReviewDate(1)">æ˜å¤©</button>
        <button class="btn btn-ghost btn-sm" style="border-radius:999px;" onclick="setReviewDate(3)">3å¤©å¾Œ</button>
        <button class="btn btn-ghost btn-sm" style="border-radius:999px;" onclick="setReviewDate(7)">1é€±å¾Œ</button>
        <button class="btn btn-ghost btn-sm" style="border-radius:999px;" onclick="setReviewDate(14)">2é€±å¾Œ</button>
      </div>
    </div>

    <div class="flex-gap" style="margin-top:4px;">
      <button class="ihb ihb-primary" onclick="addWrongQ()"><div class="ihb-bg"></div><span class="ihb-text">Save</span><div class="ihb-hover-content">Save â†’</div></button>
      <button class="ihb" onclick="closeModal('modal-wrongq')"><div class="ihb-bg"></div><span class="ihb-text">Cancel</span><div class="ihb-hover-content">Cancel â†’</div></button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-chapter">
  <div class="modal">
    <div class="modal-title">æ–°å¢ç« ç¯€</div>
    <button class="modal-close" onclick="closeModal('modal-chapter')">âœ•</button>
    <div class="form-group">
      <label class="form-label">ç§‘ç›®</label>
      <select class="form-select" id="ch-subject-input">
        <option value="physics">ç‰©ç†</option><option value="chem">åŒ–å­¸</option><option value="bio">ç”Ÿç‰©</option>
        <option value="math">æ•¸å­¸</option><option value="geo">åœ°ç†</option><option value="eng">è‹±æ–‡</option><option value="chi">åœ‹æ–‡</option>
      </select>
    </div>
    <div class="form-group"><label class="form-label">ç« ç¯€åç¨±</label><input class="form-input" id="ch-name-input" placeholder="e.g. CH3 ç‰›é “é‹å‹•å®šå¾‹" onkeydown="if(event.key==='Enter')addChapter()"></div>
    <div class="flex-gap"><button class="btn btn-primary" onclick="addChapter()">Add</button><button class="btn btn-ghost" onclick="closeModal('modal-chapter')">Cancel</button></div>
  </div>
</div>

<!-- LIGHTBOX -->
<div class="lightbox" id="lightbox" onclick="this.classList.remove('open')">
  <img id="lightbox-img" src="" alt="">
</div>

<!-- FIREBASE SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut as fbSignOut } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, collection, addDoc, getDocs, updateDoc, deleteDoc, query, where, onSnapshot, orderBy } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// YOUR FIREBASE CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const firebaseConfig = {
  apiKey: "AIzaSyAJGa2F3yzgA6DMGzCC6D3ARfS3H_sdiRU",
  authDomain: "apex-study-os.firebaseapp.com",
  projectId: "apex-study-os",
  storageBucket: "apex-study-os.firebasestorage.app",
  messagingSenderId: "722597129488",
  appId: "1:722597129488:web:3e97eade0769edffb48995",
  measurementId: "G-ZS3JEKRGMK"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACCOUNT MAPPING â€” å‰¯å¸³è™Ÿ â†’ ä¸»å¸³è™Ÿ UID
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MASTER_EMAIL = "s410315@hlhs.hlc.edu.tw";
const SHARED_ACCOUNTS = [
  "s410315@hlhs.hlc.edu.tw",
  "benjaminshih1229@gmail.com",
];
// ä¸»å¸³è™Ÿçš„ UIDï¼ˆç™»å…¥å¾Œè‡ªå‹•å¡«å…¥ï¼‰
let masterUID = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GLOBALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SUBJECTS = {
  physics: { name: 'ç‰©ç†', class: 'tag-physics' },
  chem:    { name: 'åŒ–å­¸', class: 'tag-chem' },
  bio:     { name: 'ç”Ÿç‰©', class: 'tag-bio' },
  math:    { name: 'æ•¸å­¸', class: 'tag-math' },
  geo:     { name: 'åœ°ç†', class: 'tag-geo' },
  eng:     { name: 'è‹±æ–‡', class: 'tag-eng' },
  chi:     { name: 'åœ‹æ–‡', class: 'tag-chi' },
};

let currentUser = null;
let currentNoteImg = null;
let currentNoteId = null;
let timerInterval = null, timerSeconds = 0, timerRunning = false;

// Local cache
let todos = [], notes = [], wrongQs = [], chapters = {}, exams = [], sessions = [];

// Sync status
function setSyncStatus(status, label) {
  const dot = document.getElementById('sync-dot');
  const lbl = document.getElementById('sync-label');
  dot.className = 'sync-dot ' + status;
  lbl.textContent = label;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.signInWithGoogle = async () => {
  try {
    await signInWithPopup(auth, provider);
  } catch (e) { console.error(e); alert('ç™»å…¥å¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡'); }
};

window.signOut = async () => {
  await fbSignOut(auth);
  location.reload();
};

onAuthStateChanged(auth, async (user) => {
  if (user) {
    currentUser = user;

    // æª¢æŸ¥æ˜¯å¦ç‚ºæˆæ¬Šå¸³è™Ÿ
    if (!SHARED_ACCOUNTS.includes(user.email)) {
      await fbSignOut(auth);
      alert('æ­¤å¸³è™Ÿç„¡å­˜å–æ¬Šé™');
      return;
    }

    // è§£æä¸»å¸³è™Ÿ UIDï¼š
    // å¦‚æœæ˜¯ä¸»å¸³è™Ÿæœ¬äºº â†’ æŠŠè‡ªå·±çš„ UID å­˜åˆ° Firestore mapping
    // å¦‚æœæ˜¯å‰¯å¸³è™Ÿ â†’ å¾ Firestore è®€å–ä¸»å¸³è™Ÿ UID
    const mappingRef = doc(db, 'accountMapping', 'masterUID');

    if (user.email === MASTER_EMAIL) {
      // ä¸»å¸³è™Ÿï¼šå¯«å…¥è‡ªå·±çš„ UID
      masterUID = user.uid;
      await setDoc(mappingRef, { uid: user.uid }, { merge: true });
    } else {
      // å‰¯å¸³è™Ÿï¼šè®€å–ä¸»å¸³è™Ÿ UID
      const mappingSnap = await getDoc(mappingRef);
      if (mappingSnap.exists()) {
        masterUID = mappingSnap.data().uid;
      } else {
        alert('è«‹å…ˆç”¨ä¸»å¸³è™Ÿï¼ˆs410315@hlhs.hlc.edu.twï¼‰ç™»å…¥ä¸€æ¬¡ï¼Œå»ºç«‹è³‡æ–™å¾Œå‰¯å¸³è™Ÿæ‰èƒ½å­˜å–ã€‚');
        await fbSignOut(auth);
        return;
      }
    }

    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('app-shell').style.display = 'flex';
    document.getElementById('user-name').textContent = user.displayName || user.email;
    if (user.photoURL) document.getElementById('user-avatar').src = user.photoURL;
    setSyncStatus('syncing', 'Loading...');
    await loadAllData();
    setSyncStatus('synced', 'Synced');
    renderDashboard();
    setupRealtimeListeners();
  } else {
    document.getElementById('login-screen').style.display = 'flex';
    document.getElementById('app-shell').style.display = 'none';
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIRESTORE HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function uid() { return masterUID || currentUser.uid; }

function col(name) { return collection(db, 'users', uid(), name); }

async function loadAllData() {
  const [todosSnap, notesSnap, wrongSnap, chSnap, examsSnap, sessSnap] = await Promise.all([
    getDocs(query(col('todos'), orderBy('day', 'desc'))),
    getDocs(query(col('notes'), orderBy('date', 'desc'))),
    getDocs(query(col('wrongq'), orderBy('date', 'desc'))),
    getDocs(col('chapters')),
    getDocs(col('exams')),
    getDocs(col('sessions')),
  ]);
  todos    = todosSnap.docs.map(d => ({ id: d.id, ...d.data() }));
  notes    = notesSnap.docs.map(d => ({ id: d.id, ...d.data() }));
  wrongQs  = wrongSnap.docs.map(d => ({ id: d.id, ...d.data() }));
  exams    = examsSnap.docs.map(d => ({ id: d.id, ...d.data() }));
  sessions = sessSnap.docs.map(d => ({ id: d.id, ...d.data() }));
  chapters = {};
  chSnap.docs.forEach(d => {
    const data = d.data();
    if (!chapters[data.subject]) chapters[data.subject] = [];
    chapters[data.subject].push({ id: d.id, ...data });
  });
}

function setupRealtimeListeners() {
  onSnapshot(col('todos'), snap => {
    todos = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    renderTodos(); updateDashboardStats();
  });
  onSnapshot(col('wrongq'), snap => {
    wrongQs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    updateDashboardStats();
  });
  onSnapshot(col('chapters'), snap => {
    chapters = {};
    snap.docs.forEach(d => {
      const data = d.data();
      if (!chapters[data.subject]) chapters[data.subject] = [];
      chapters[data.subject].push({ id: d.id, ...data });
    });
    updateDashboardStats();
  });
}

async function fbAdd(collName, data) {
  setSyncStatus('syncing', 'Saving...');
  const ref = await addDoc(col(collName), data);
  setSyncStatus('synced', 'Synced âœ“');
  return ref.id;
}

async function fbUpdate(collName, id, data) {
  setSyncStatus('syncing', 'Saving...');
  await updateDoc(doc(db, 'users', uid(), collName, id), data);
  setSyncStatus('synced', 'Synced âœ“');
}

async function fbDelete(collName, id) {
  setSyncStatus('syncing', 'Deleting...');
  await deleteDoc(doc(db, 'users', uid(), collName, id));
  setSyncStatus('synced', 'Synced âœ“');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.showPage = (id) => {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-' + id).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n => {
    if (n.getAttribute('onclick')?.includes("'" + id + "'")) n.classList.add('active');
  });
  if (id === 'dashboard') renderDashboard();
  if (id === 'progress')  renderChapterTree();
  if (id === 'notes')     renderNotes();
  if (id === 'wrongq')    renderWrongQ();
  if (id === 'exams')     renderExams();
  if (id === 'timer')     renderSessionLog();
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.openModal  = (id) => document.getElementById(id).classList.add('open');
window.closeModal = (id) => document.getElementById(id).classList.remove('open');
document.querySelectorAll('.modal-overlay').forEach(o => {
  o.addEventListener('click', e => { if (e.target === o) o.classList.remove('open'); });
});

window.openAddTodo    = () => { document.getElementById('todo-input').value = ''; openModal('modal-todo'); setTimeout(() => document.getElementById('todo-input').focus(), 50); };
window.openAddNote    = () => { currentNoteImg = null; document.getElementById('note-img-preview').innerHTML = ''; ['note-title-input','note-chapter-input','note-summary-input','note-questions-input'].forEach(id => document.getElementById(id).value = ''); openModal('modal-note'); };
window.openAddWrongQ  = () => { ['wq-question-input','wq-reason-input','wq-solution-input'].forEach(id => document.getElementById(id).value = ''); openModal('modal-wrongq'); };
window.openAddChapter = () => { document.getElementById('ch-name-input').value = ''; openModal('modal-chapter'); };

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDashboard() {
  const now = new Date();
  document.getElementById('today-date-label').textContent = now.toLocaleDateString('zh-TW', { weekday:'short', year:'numeric', month:'long', day:'numeric' });
  updateDashboardStats();
  renderTodos();
}

function updateDashboardStats() {
  const now = new Date();
  const today = now.toDateString();
  const todayMins = sessions.filter(s => new Date(s.date).toDateString() === today).reduce((a,s) => a + (s.minutes||0), 0);
  document.getElementById('dash-study-time').textContent = todayMins;

  const upcoming = exams.filter(e => new Date(e.date) >= now).sort((a,b) => new Date(a.date)-new Date(b.date));
  if (upcoming.length) {
    document.getElementById('dash-next-exam').textContent = Math.ceil((new Date(upcoming[0].date) - now) / 86400000);
    document.getElementById('dash-next-exam-name').textContent = upcoming[0].name;
  }

  document.getElementById('dash-wrong-count').textContent = wrongQs.filter(q => !q.mastered).length;

  const allChaps = Object.values(chapters).flat();
  const mastered = allChaps.filter(c => c.status === 'mastered').length;
  const pct = allChaps.length ? Math.round(mastered / allChaps.length * 100) : 0;
  document.getElementById('dash-overall-pct').textContent = pct + '%';

  document.getElementById('dash-subject-overview').innerHTML = Object.keys(SUBJECTS).map(key => {
    const chaps = chapters[key] || [];
    const m = chaps.filter(c => c.status === 'mastered').length;
    const total = chaps.length;
    const p = total ? Math.round(m / total * 100) : 0;
    const color = p > 70 ? 'var(--green)' : p > 30 ? 'var(--yellow)' : 'var(--accent)';
    return `<div class="subject-row"><div class="subject-name">${SUBJECTS[key].name}</div><div class="subject-bar-wrap"><div class="subject-bar-fill" style="width:${p}%;background:${color};"></div></div><div class="subject-pct">${p}%</div></div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TODOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTodos() {
  const today = new Date().toDateString();
  const todayTodos = todos.filter(t => t.day === today);
  const list = document.getElementById('todo-list');
  const empty = document.getElementById('todo-empty');
  if (!todayTodos.length) { list.innerHTML = ''; empty.style.display = ''; return; }
  empty.style.display = 'none';
  list.innerHTML = todayTodos.map(t => `
    <div class="todo-item">
      <div class="todo-checkbox ${t.done ? 'checked' : ''}" onclick="toggleTodo('${t.id}')"></div>
      <div class="todo-text ${t.done ? 'done' : ''}">${t.text}${t.subject ? ` <span class="tag ${SUBJECTS[t.subject]?.class||''}">${SUBJECTS[t.subject]?.name}</span>` : ''}</div>
      <button class="btn btn-danger btn-sm" onclick="deleteTodo('${t.id}')">âœ•</button>
    </div>`).join('');
}

window.addTodo = async () => {
  const text = document.getElementById('todo-input').value.trim();
  if (!text) return;
  await fbAdd('todos', { text, subject: document.getElementById('todo-subject-input').value, done: false, day: new Date().toDateString() });
  closeModal('modal-todo');
};

window.toggleTodo = async (id) => {
  const t = todos.find(t => t.id === id);
  if (t) await fbUpdate('todos', id, { done: !t.done });
};

window.deleteTodo = async (id) => { await fbDelete('todos', id); };

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TIMER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.timerStart = () => {
  if (timerRunning) return;
  timerRunning = true;
  document.getElementById('timer-display').classList.add('running');
  timerInterval = setInterval(() => { timerSeconds++; updateTimerDisplay(); }, 1000);
};

window.timerPause = () => {
  timerRunning = false;
  clearInterval(timerInterval);
  document.getElementById('timer-display').classList.remove('running');
};

window.timerReset = () => { timerPause(); timerSeconds = 0; updateTimerDisplay(); };

function updateTimerDisplay() {
  const h = Math.floor(timerSeconds/3600), m = Math.floor((timerSeconds%3600)/60), s = timerSeconds%60;
  document.getElementById('timer-display').textContent = [h,m,s].map(n => String(n).padStart(2,'0')).join(':');
}

window.saveSession = async () => {
  if (timerSeconds < 60) { alert('è«‹è‡³å°‘è¨ˆæ™‚ 1 åˆ†é˜'); return; }
  const minutes = Math.round(timerSeconds / 60);
  await fbAdd('sessions', { subject: document.getElementById('timer-subject').value, minutes, date: new Date().toISOString() });
  sessions = [...sessions]; // trigger re-render
  timerReset();
  const snap = await getDocs(col('sessions'));
  sessions = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  renderSessionLog();
  updateDashboardStats();
};

function renderSessionLog() {
  const today = new Date().toDateString();
  const todaySessions = sessions.filter(s => new Date(s.date).toDateString() === today);
  const el = document.getElementById('session-log');
  const empty = document.getElementById('session-empty');
  if (!todaySessions.length) { el.innerHTML = ''; empty.style.display = ''; return; }
  empty.style.display = 'none';
  el.innerHTML = todaySessions.map(s => `
    <div class="subject-row">
      <span class="tag ${SUBJECTS[s.subject]?.class||''}">${SUBJECTS[s.subject]?.name}</span>
      <div style="flex:1;"></div>
      <span style="font-family:var(--font-display);color:var(--green);font-size:14px;">${s.minutes}</span>
      <span style="font-size:11px;color:var(--text-dim);margin-left:4px;">min</span>
    </div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHAPTERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderChapterTree() {
  document.getElementById('chapter-tree').innerHTML = Object.keys(SUBJECTS).map(key => {
    const chaps = chapters[key] || [];
    const mastered = chaps.filter(c => c.status === 'mastered').length;
    const pct = chaps.length ? Math.round(mastered / chaps.length * 100) : 0;
    const barColor = pct > 70 ? 'var(--green)' : pct > 30 ? 'var(--yellow)' : 'var(--accent)';
    return `
      <div class="chapter-subject-section">
        <div class="chapter-subject-header" onclick="this.nextElementSibling.classList.toggle('open')">
          <div class="flex-gap">
            <span class="tag ${SUBJECTS[key].class}">${SUBJECTS[key].name}</span>
            <span style="font-family:var(--font-mono);font-size:11px;color:var(--text-sec);">${mastered}/${chaps.length} æŒæ¡</span>
          </div>
          <div style="display:flex;align-items:center;gap:12px;">
            <div style="width:100px;background:var(--bg-3);border-radius:2px;height:4px;"><div style="width:${pct}%;height:100%;border-radius:2px;background:${barColor};"></div></div>
          </div>
        </div>
        <div class="chapter-list open">
          ${chaps.map(c => `
            <div class="chapter-item">
              <div class="chapter-status ${c.status}" onclick="cycleChapterStatus('${c.id}','${key}','${c.status}')" title="é»æ“Šåˆ‡æ›">
                ${c.status==='mastered'?'âœ“':c.status==='fuzzy'?'~':'â—‹'}
              </div>
              <div class="chapter-name">${c.name}</div>
              <button class="btn btn-danger btn-sm" onclick="deleteChapter('${c.id}')">âœ•</button>
            </div>`).join('')}
          <button class="chapter-add-btn" onclick="openAddChapterFor('${key}')">+ æ–°å¢ç« ç¯€</button>
        </div>
      </div>`;
  }).join('');
}

window.cycleChapterStatus = async (id, subject, current) => {
  const order = ['not-started', 'fuzzy', 'mastered'];
  const next = order[(order.indexOf(current) + 1) % order.length];
  await fbUpdate('chapters', id, { status: next });
  const snap = await getDocs(col('chapters'));
  chapters = {};
  snap.docs.forEach(d => {
    const data = d.data();
    if (!chapters[data.subject]) chapters[data.subject] = [];
    chapters[data.subject].push({ id: d.id, ...data });
  });
  renderChapterTree();
  updateDashboardStats();
};

window.deleteChapter = async (id) => { await fbDelete('chapters', id); const snap = await getDocs(col('chapters')); chapters={}; snap.docs.forEach(d=>{const data=d.data();if(!chapters[data.subject])chapters[data.subject]=[];chapters[data.subject].push({id:d.id,...data});}); renderChapterTree(); };

window.openAddChapterFor = (subject) => { document.getElementById('ch-subject-input').value = subject; openAddChapter(); };

window.addChapter = async () => {
  const name = document.getElementById('ch-name-input').value.trim();
  if (!name) return;
  await fbAdd('chapters', { name, subject: document.getElementById('ch-subject-input').value, status: 'not-started' });
  closeModal('modal-chapter');
  const snap = await getDocs(col('chapters'));
  chapters = {};
  snap.docs.forEach(d => { const data = d.data(); if (!chapters[data.subject]) chapters[data.subject]=[]; chapters[data.subject].push({id:d.id,...data}); });
  renderChapterTree();
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NOTES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.handleNoteImage = (input) => {
  const file = input.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = e => { currentNoteImg = e.target.result; document.getElementById('note-img-preview').innerHTML = `<img src="${currentNoteImg}" style="max-width:100%;max-height:120px;border-radius:4px;border:1px solid var(--border);">`; };
  reader.readAsDataURL(file);
};

window.addNote = async () => {
  const title = document.getElementById('note-title-input').value.trim();
  if (!title) return;
  await fbAdd('notes', {
    title,
    subject: document.getElementById('note-subject-input').value,
    chapter: document.getElementById('note-chapter-input').value.trim(),
    summary: document.getElementById('note-summary-input').value.trim(),
    questions: document.getElementById('note-questions-input').value.trim(),
    image: currentNoteImg || null,
    date: new Date().toISOString(),
  });
  closeModal('modal-note');
  const snap = await getDocs(query(col('notes'), orderBy('date','desc')));
  notes = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  renderNotes();
};

function renderNotes() {
  const filter = document.getElementById('notes-filter').value;
  const filtered = filter === 'all' ? notes : notes.filter(n => n.subject === filter);
  const grid = document.getElementById('notes-grid');
  const empty = document.getElementById('notes-empty');
  if (!filtered.length) { grid.innerHTML = ''; empty.style.display = ''; return; }
  empty.style.display = 'none';
  grid.innerHTML = filtered.map(n => `
    <div class="note-card" onclick="openNoteDetail('${n.id}')">
      <div class="note-card-title">${n.title}</div>
      <div class="note-card-meta">${new Date(n.date).toLocaleDateString('zh-TW')} Â· ${n.chapter||''}</div>
      <div class="flex-gap" style="margin-bottom:8px;"><span class="tag ${SUBJECTS[n.subject]?.class||''}">${SUBJECTS[n.subject]?.name}</span></div>
      ${n.summary ? `<div class="note-card-preview">${n.summary.slice(0,80)}${n.summary.length>80?'...':''}</div>` : ''}
      ${n.image ? `<img src="${n.image}" class="note-image-thumb" alt="">` : ''}
    </div>`).join('');
}

window.openNoteDetail = (id) => {
  const n = notes.find(n => n.id === id); if (!n) return;
  currentNoteId = id;
  document.getElementById('note-detail-title').textContent = n.title;
  document.getElementById('note-detail-meta').textContent = `${new Date(n.date).toLocaleDateString('zh-TW')} Â· ${n.chapter||''}`;
  document.getElementById('note-detail-tags').innerHTML = `<span class="tag ${SUBJECTS[n.subject]?.class||''}">${SUBJECTS[n.subject]?.name}</span>`;
  const img = document.getElementById('note-detail-img');
  if (n.image) { img.src = n.image; img.style.display = ''; } else img.style.display = 'none';
  document.getElementById('note-detail-summary').textContent = n.summary || 'ï¼ˆç„¡æ‘˜è¦ï¼‰';
  document.getElementById('note-detail-questions').innerHTML = n.questions
    ? `<div style="font-family:var(--font-mono);font-size:9px;letter-spacing:2px;color:var(--text-dim);margin-bottom:8px;">â“ å¾…è§£å•é¡Œ</div>` +
      n.questions.split('\n').filter(Boolean).map(q => `<div style="padding:6px 10px;background:rgba(255,209,102,0.06);border-left:2px solid var(--yellow);margin-bottom:6px;font-size:13px;border-radius:2px;">${q}</div>`).join('') : '';
  document.getElementById('notes-list-view').classList.add('hidden');
  document.getElementById('note-detail-view').classList.add('open');
};

window.closeNoteDetail = () => { document.getElementById('note-detail-view').classList.remove('open'); document.getElementById('notes-list-view').classList.remove('hidden'); };

window.deleteCurrentNote = async () => {
  if (!currentNoteId || !confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) return;
  await fbDelete('notes', currentNoteId);
  const snap = await getDocs(query(col('notes'), orderBy('date','desc')));
  notes = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  closeNoteDetail(); renderNotes();
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WRONG Q
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let wqSelectedErrorType = '';
let wqSelectedStars = 0;
let wqCurrentImg = null;

const ERROR_TYPES = {
  careless: { label: 'ğŸ˜µ ç²—å¿ƒ',    color: 'var(--yellow)' },
  concept:  { label: 'ğŸ§  è§€å¿µéŒ¯èª¤', color: 'var(--red)' },
  formula:  { label: 'ğŸ“ å…¬å¼è¨˜éŒ¯', color: 'var(--purple)' },
  calc:     { label: 'ğŸ”¢ å°è¨ˆç®—éŒ¯', color: 'var(--cyan)' },
  reading:  { label: 'ğŸ“– é¡Œæ„çœ‹éŒ¯', color: '#ff9f43' },
  other:    { label: 'â“ å…¶ä»–',     color: 'var(--text-sec)' },
};

window.selectErrorType = (type) => {
  wqSelectedErrorType = type;
  document.querySelectorAll('.error-chip').forEach(c => {
    c.className = 'error-chip';
    if (c.dataset.type === type) c.classList.add('selected-' + type);
  });
};

window.selectStar = (n) => {
  wqSelectedStars = n;
  const labels = ['', 'ç°¡å–®', 'æ™®é€š', 'ä¸­ç­‰', 'å›°é›£', 'åœ°ç„'];
  document.querySelectorAll('.star').forEach((s, i) => {
    s.classList.toggle('active', i < n);
  });
  document.getElementById('wq-star-label').textContent = labels[n] || 'æœªé¸æ“‡';
};

window.setReviewDate = (days) => {
  const d = new Date();
  d.setDate(d.getDate() + days);
  document.getElementById('wq-review-date-input').value = d.toISOString().slice(0,10);
};

window.handleWQImage = (input) => {
  const file = input.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    wqCurrentImg = e.target.result;
    document.getElementById('wq-img-preview').innerHTML = `<img src="${wqCurrentImg}" style="max-width:100%;max-height:140px;border-radius:4px;border:1px solid var(--border);">`;
  };
  reader.readAsDataURL(file);
};

window.openLightbox = (src) => {
  document.getElementById('lightbox-img').src = src;
  document.getElementById('lightbox').classList.add('open');
};

window.addWrongQ = async () => {
  const question = document.getElementById('wq-question-input').value.trim();
  if (!question) { alert('è«‹å¡«å…¥é¡Œç›®æè¿°'); return; }
  await fbAdd('wrongq', {
    subject:    document.getElementById('wq-subject-input').value,
    source:     document.getElementById('wq-source-input').value,
    chapter:    document.getElementById('wq-chapter-input').value.trim(),
    errorType:  wqSelectedErrorType,
    difficulty: wqSelectedStars,
    question,
    image:      wqCurrentImg || null,
    reason:     document.getElementById('wq-reason-input').value.trim(),
    solution:   document.getElementById('wq-solution-input').value.trim(),
    reviewDate: document.getElementById('wq-review-date-input').value || null,
    mastered:   false,
    attempts:   0,
    date:       new Date().toISOString(),
  });
  // reset
  wqSelectedErrorType = ''; wqSelectedStars = 0; wqCurrentImg = null;
  document.querySelectorAll('.error-chip').forEach(c => c.className = 'error-chip');
  document.querySelectorAll('.star').forEach(s => s.classList.remove('active'));
  document.getElementById('wq-star-label').textContent = 'æœªé¸æ“‡';
  document.getElementById('wq-img-preview').innerHTML = '';
  ['wq-question-input','wq-reason-input','wq-solution-input','wq-chapter-input','wq-review-date-input'].forEach(id => document.getElementById(id).value = '');

  closeModal('modal-wrongq');
  const snap = await getDocs(query(col('wrongq'), orderBy('date','desc')));
  wrongQs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  renderWrongQ(); updateDashboardStats();
};

window.openAddWrongQ = () => {
  wqSelectedErrorType = ''; wqSelectedStars = 0; wqCurrentImg = null;
  document.querySelectorAll('.error-chip').forEach(c => c.className = 'error-chip');
  document.querySelectorAll('.star').forEach(s => s.classList.remove('active'));
  document.getElementById('wq-star-label').textContent = 'æœªé¸æ“‡';
  document.getElementById('wq-img-preview').innerHTML = '';
  ['wq-question-input','wq-reason-input','wq-solution-input','wq-chapter-input','wq-review-date-input'].forEach(id => document.getElementById(id).value = '');
  openModal('modal-wrongq');
};

function getReviewBadge(reviewDate) {
  if (!reviewDate) return '';
  const now = new Date(); now.setHours(0,0,0,0);
  const rd = new Date(reviewDate); rd.setHours(0,0,0,0);
  const diff = Math.ceil((rd - now) / 86400000);
  if (diff <= 0) return `<span class="review-badge review-due">ğŸ”” ä»Šæ—¥è¤‡ç¿’</span>`;
  if (diff <= 3) return `<span class="review-badge review-soon">â° ${diff}å¤©å¾Œè¤‡ç¿’</span>`;
  return `<span class="review-badge review-ok">ğŸ“… ${diff}å¤©å¾Œè¤‡ç¿’</span>`;
}

function getStars(n) {
  if (!n) return '';
  return 'â˜…'.repeat(n) + 'â˜†'.repeat(5-n);
}

function renderWQStats() {
  const total = wrongQs.length;
  const pending = wrongQs.filter(q => !q.mastered).length;
  const mastered = wrongQs.filter(q => q.mastered).length;
  const accuracy = total ? Math.round(mastered / total * 100) : 0;

  // Most common error type
  const typeCounts = {};
  wrongQs.forEach(q => { if (q.errorType) typeCounts[q.errorType] = (typeCounts[q.errorType]||0)+1; });
  const topType = Object.entries(typeCounts).sort((a,b)=>b[1]-a[1])[0];

  // Due today
  const now = new Date(); now.setHours(0,0,0,0);
  const dueToday = wrongQs.filter(q => {
    if (!q.reviewDate || q.mastered) return false;
    const rd = new Date(q.reviewDate); rd.setHours(0,0,0,0);
    return rd <= now;
  }).length;

  document.getElementById('wq-stats').innerHTML = `
    <div class="wq-stat">
      <div class="wq-stat-label">Total Wrong</div>
      <div class="wq-stat-value">${total}</div>
    </div>
    <div class="wq-stat">
      <div class="wq-stat-label">Mastery Rate</div>
      <div class="wq-stat-value" style="color:${accuracy>60?'var(--green)':accuracy>30?'var(--yellow)':'var(--red)'}">${accuracy}%</div>
    </div>
    <div class="wq-stat">
      <div class="wq-stat-label">Due Today</div>
      <div class="wq-stat-value" style="color:${dueToday>0?'var(--red)':'var(--green)'}">${dueToday}</div>
    </div>
    <div class="wq-stat">
      <div class="wq-stat-label">Top Error</div>
      <div style="font-size:13px;margin-top:4px;color:var(--text-sec);">${topType ? ERROR_TYPES[topType[0]]?.label || topType[0] : 'â€”'}</div>
    </div>`;
}

function renderWrongQ() {
  renderWQStats();
  const subFilter    = document.getElementById('wrongq-filter').value;
  const typeFilter   = document.getElementById('wrongq-type-filter').value;
  const diffFilter   = document.getElementById('wrongq-difficulty-filter').value;
  const statusFilter = document.getElementById('wrongq-status-filter').value;
  const now = new Date(); now.setHours(0,0,0,0);

  let filtered = wrongQs;
  if (subFilter !== 'all')    filtered = filtered.filter(q => q.subject === subFilter);
  if (typeFilter !== 'all')   filtered = filtered.filter(q => q.errorType === typeFilter);
  if (diffFilter !== 'all')   filtered = filtered.filter(q => String(q.difficulty) === diffFilter);
  if (statusFilter === 'pending')  filtered = filtered.filter(q => !q.mastered);
  if (statusFilter === 'mastered') filtered = filtered.filter(q => q.mastered);
  if (statusFilter === 'due') filtered = filtered.filter(q => {
    if (!q.reviewDate || q.mastered) return false;
    const rd = new Date(q.reviewDate); rd.setHours(0,0,0,0);
    return rd <= now;
  });

  const el = document.getElementById('wrongq-list');
  const empty = document.getElementById('wrongq-empty');
  if (!filtered.length) { el.innerHTML = ''; empty.style.display = ''; return; }
  empty.style.display = 'none';

  el.innerHTML = filtered.map(q => {
    const et = q.errorType ? ERROR_TYPES[q.errorType] : null;
    const stars = q.difficulty ? `<span style="color:var(--yellow);letter-spacing:1px;font-size:11px;">${getStars(q.difficulty)}</span>` : '';
    const etTag = et ? `<span class="tag" style="color:${et.color};border-color:${et.color}30;background:${et.color}10;">${et.label}</span>` : '';
    const reviewBadge = getReviewBadge(q.reviewDate);
    const chTag = q.chapter ? `<span class="tag" style="color:var(--text-sec);border-color:var(--border);">${q.chapter}</span>` : '';
    return `
    <div class="wrongq-card ${q.mastered?'mastered':''}">
      <div class="wrongq-header">
        <span class="tag ${SUBJECTS[q.subject]?.class||''}">${SUBJECTS[q.subject]?.name}</span>
        ${chTag}
        <span class="tag" style="color:var(--text-sec);border-color:var(--border);">${q.source}</span>
        ${etTag}
        ${stars}
        ${reviewBadge}
        <span class="tag ${q.mastered?'tag-green':'tag-red'}" style="margin-left:auto;">${q.mastered?'MASTERED':'PENDING'}</span>
        <span style="font-family:var(--font-mono);font-size:9px;color:var(--text-dim);">${new Date(q.date).toLocaleDateString('zh-TW')}</span>
      </div>
      <div class="wrongq-question">${q.question}</div>
      ${q.image ? `<img class="wrongq-img" src="${q.image}" alt="" onclick="openLightbox('${q.image.replace(/'/g,"\\'")}')">` : ''}
      ${q.reason   ? `<div class="wrongq-reason">âŒ éŒ¯èª¤åŸå› ï¼š${q.reason}</div>` : ''}
      ${q.solution ? `<div class="wrongq-solution">âœ… æ­£ç¢ºè§£æ³•ï¼š${q.solution}</div>` : ''}
      <div class="wrongq-actions">
        <button class="ihb ${q.mastered?'':'ihb-green'}" onclick="toggleWQMastered('${q.id}',${q.mastered})">
          <div class="ihb-bg"></div>
          <span class="ihb-text">${q.mastered?'â†© é‡ç·´':'âœ“ å·²æŒæ¡'}</span>
          <div class="ihb-hover-content">${q.mastered?'â†© é‡ç·´ â†’':'âœ“ å·²æŒæ¡ â†’'}</div>
        </button>
        <button class="ihb ihb-danger" onclick="deleteWrongQ('${q.id}')">
          <div class="ihb-bg"></div>
          <span class="ihb-text">âœ• åˆªé™¤</span>
          <div class="ihb-hover-content">âœ• åˆªé™¤ â†’</div>
        </button>
      </div>
    </div>`;
  }).join('');
}

window.toggleWQMastered = async (id, current) => {
  await fbUpdate('wrongq', id, { mastered: !current });
  const snap = await getDocs(query(col('wrongq'), orderBy('date','desc')));
  wrongQs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  renderWrongQ(); updateDashboardStats();
};

window.deleteWrongQ = async (id) => {
  if (!confirm('ç¢ºå®šåˆªé™¤é€™é¡Œï¼Ÿ')) return;
  await fbDelete('wrongq', id);
  wrongQs = wrongQs.filter(q => q.id !== id);
  renderWrongQ(); updateDashboardStats();
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXAMS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addExam = async () => {
  const name = document.getElementById('exam-name-input').value.trim();
  const date = document.getElementById('exam-date-input').value;
  if (!name || !date) { alert('è«‹å¡«å…¥åç¨±å’Œæ—¥æœŸ'); return; }
  await fbAdd('exams', { name, date, scope: document.getElementById('exam-scope-input').value.trim() });
  ['exam-name-input','exam-date-input','exam-scope-input'].forEach(id => document.getElementById(id).value = '');
  const snap = await getDocs(col('exams'));
  exams = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  renderExams(); updateDashboardStats();
};

function renderExams() {
  const now = new Date();
  const sorted = [...exams].sort((a,b) => new Date(a.date)-new Date(b.date));
  const el = document.getElementById('exam-list');
  const empty = document.getElementById('exam-empty');
  if (!sorted.length) { el.innerHTML = ''; empty.style.display = ''; return; }
  empty.style.display = 'none';
  el.innerHTML = sorted.map(e => {
    const days = Math.ceil((new Date(e.date) - now) / 86400000);
    const isPast = days < 0;
    const color = isPast ? 'var(--text-dim)' : days <= 7 ? 'var(--red)' : days <= 30 ? 'var(--yellow)' : 'var(--green)';
    return `
      <div style="padding:14px;background:var(--bg-2);border:1px solid var(--border);border-radius:var(--radius-lg);margin-bottom:10px;">
        <div class="flex-between">
          <div>
            <div style="font-size:14px;font-weight:500;margin-bottom:4px;">${e.name}</div>
            <div style="font-family:var(--font-mono);font-size:10px;color:var(--text-dim);">${e.date}${e.scope?' Â· '+e.scope:''}</div>
          </div>
          <div style="text-align:right;">
            <div style="font-family:var(--font-display);font-size:24px;font-weight:700;color:${color};line-height:1;">${isPast?'DONE':days}</div>
            <div style="font-family:var(--font-mono);font-size:9px;color:var(--text-dim);">${isPast?'':'days left'}</div>
          </div>
        </div>
        <button class="btn btn-danger btn-sm" style="margin-top:8px;" onclick="deleteExam('${e.id}')">âœ• åˆªé™¤</button>
      </div>`;
  }).join('');
}

window.deleteExam = async (id) => {
  await fbDelete('exams', id);
  exams = exams.filter(e => e.id !== id);
  renderExams(); updateDashboardStats();
};

// INIT
updateTimerDisplay();
</script>
</body>
</html>
