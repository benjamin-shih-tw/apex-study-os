<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>APEX STUDY OS</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Space+Mono:wght@400;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
:root {
  --z950:#09090b; --z900:#18181b; --z800:#27272a; --z700:#3f3f46;
  --z600:#52525b; --z500:#71717a; --z400:#a1a1aa; --z300:#d4d4d8;
  --w5:rgba(255,255,255,0.05); --w8:rgba(255,255,255,0.08);
  --w10:rgba(255,255,255,0.10); --w15:rgba(255,255,255,0.15);
  --w20:rgba(255,255,255,0.20);
  --green:#4ade80; --yellow:#fbbf24; --red:#f87171;
  --blue:#60a5fa; --purple:#c084fc; --cyan:#22d3ee; --orange:#fb923c;
  --sans:'Inter','Noto Sans TC',sans-serif; --mono:'Space Mono',monospace;
  --r:12px; --rl:16px; --rxl:20px; --rf:999px;
  --sw:240px;
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
html{scroll-behavior:smooth}
body{background:var(--z950);color:#d4d4d8;font-family:var(--sans);font-size:15px;min-height:100vh;overflow-x:hidden;-webkit-font-smoothing:antialiased}

/* ambient blobs */
.bg-blob-1{position:fixed;top:-150px;right:-150px;width:500px;height:500px;background:radial-gradient(circle,rgba(96,165,250,.07) 0%,transparent 70%);pointer-events:none;z-index:0}
.bg-blob-2{position:fixed;bottom:-150px;left:-100px;width:400px;height:400px;background:radial-gradient(circle,rgba(192,132,252,.05) 0%,transparent 70%);pointer-events:none;z-index:0}

::-webkit-scrollbar{width:4px;height:4px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--z700);border-radius:99px}

/* â”€â”€ SYNC BAR â”€â”€ */
#sync-bar{position:fixed;top:0;left:0;right:0;height:26px;background:rgba(9,9,11,.9);border-bottom:1px solid var(--w10);backdrop-filter:blur(12px);display:flex;align-items:center;justify-content:flex-end;padding:0 16px;gap:6px;z-index:300;font-family:var(--mono);font-size:9px;letter-spacing:1px}
.sync-dot{width:6px;height:6px;border-radius:50%;background:var(--z600);transition:all .3s;flex-shrink:0}
.sync-dot.synced{background:var(--green);box-shadow:0 0 8px var(--green)}
.sync-dot.syncing{background:var(--yellow);animation:pulse 1s infinite}
.sync-dot.error{background:var(--red)}
#sync-label{color:var(--z500)}
@keyframes pulse{0%,100%{opacity:.5}50%{opacity:1}}
@keyframes fadeUp{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}
@keyframes ping{75%,100%{transform:scale(2);opacity:0}}

/* â”€â”€ LOGIN â”€â”€ */
#login-screen{position:fixed;inset:0;background:var(--z950);z-index:500;display:flex;align-items:center;justify-content:center}
.login-box{position:relative;background:var(--w5);border:1px solid var(--w10);border-radius:var(--rxl);padding:48px 40px;width:380px;text-align:center;backdrop-filter:blur(20px);box-shadow:0 40px 80px rgba(0,0,0,.45);animation:fadeUp .5s ease}
.login-badge{display:inline-flex;align-items:center;gap:6px;background:var(--w8);border:1px solid var(--w10);border-radius:var(--rf);padding:4px 12px;font-size:10px;font-family:var(--mono);letter-spacing:2px;color:var(--z400);margin-bottom:20px}
.pingdot{position:relative;display:inline-flex;width:7px;height:7px}
.pingdot span:first-child{position:absolute;inset:0;border-radius:50%;background:var(--green);animation:ping 1.5s cubic-bezier(0,0,.2,1) infinite;opacity:.75}
.pingdot span:last-child{position:relative;display:inline-flex;border-radius:50%;width:7px;height:7px;background:var(--green)}
.login-title{font-size:42px;font-weight:800;letter-spacing:-2px;background:linear-gradient(180deg,#fff 0%,rgba(255,255,255,.6) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;line-height:1;margin-bottom:6px}
.login-sub{font-size:11px;color:var(--z600);letter-spacing:1px;margin-bottom:32px}
.btn-google{display:flex;align-items:center;justify-content:center;gap:10px;width:100%;padding:13px;background:#fff;border:none;border-radius:var(--rf);font-family:var(--sans);font-size:14px;font-weight:600;color:#18181b;cursor:pointer;transition:all .2s}
.btn-google:hover{background:#f4f4f5;transform:translateY(-1px);box-shadow:0 8px 24px rgba(0,0,0,.3)}
.login-fine{margin-top:18px;font-size:10px;color:var(--z600)}

/* â”€â”€ APP SHELL â”€â”€ */
.app-shell{display:flex;min-height:100vh;position:relative;z-index:1;padding-top:26px}

/* â”€â”€ SIDEBAR â”€â”€ */
.sidebar{width:var(--sw);flex-shrink:0;position:fixed;top:26px;left:0;bottom:0;background:rgba(9,9,11,.7);border-right:1px solid var(--w10);backdrop-filter:blur(20px);display:flex;flex-direction:column;z-index:100}
.sidebar-logo{padding:22px 20px 18px;border-bottom:1px solid var(--w8)}
.logo-word{font-size:22px;font-weight:800;letter-spacing:-1px;background:linear-gradient(135deg,#fff 0%,rgba(255,255,255,.55) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;line-height:1}
.logo-sub{font-family:var(--mono);font-size:9px;letter-spacing:2px;color:var(--z600);margin-top:3px;text-transform:uppercase}
.sidebar-user{display:flex;align-items:center;gap:9px;padding:12px 16px;border-bottom:1px solid var(--w8)}
.user-avatar{width:28px;height:28px;border-radius:50%;border:1px solid var(--w15);object-fit:cover;flex-shrink:0;background:var(--z800)}
.user-name{font-size:12px;font-weight:500;color:var(--z300);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.btn-logout{background:none;border:none;color:var(--z600);font-size:14px;cursor:pointer;padding:3px 5px;border-radius:5px;transition:all .15s;line-height:1}
.btn-logout:hover{color:var(--red);background:rgba(248,113,113,.1)}
.sidebar-nav{flex:1;padding:10px;overflow-y:auto}
.nav-sec{font-family:var(--mono);font-size:8px;letter-spacing:2px;color:var(--z700);text-transform:uppercase;padding:10px 8px 5px}
.nav-item{display:flex;align-items:center;gap:9px;padding:9px 10px;border-radius:10px;cursor:pointer;transition:all .15s;font-size:15px;color:var(--z500);border:1px solid transparent}
.nav-item:hover{background:var(--w5);color:var(--z200)}
.nav-item.active{background:var(--w10);color:#fff;border-color:var(--w15)}
.nav-icon{font-size:14px;width:19px;text-align:center;flex-shrink:0;opacity:.7}
.nav-item.active .nav-icon{opacity:1}

/* â”€â”€ MAIN â”€â”€ */
.main-content{margin-left:var(--sw);flex:1;padding:30px 34px;min-height:100vh}
.page{display:none;animation:fadeUp .22s ease}
.page.active{display:block}

/* â”€â”€ PAGE HEADER â”€â”€ */
.page-header{margin-bottom:26px;display:flex;align-items:flex-end;justify-content:space-between;flex-wrap:wrap;gap:8px}
.page-title{font-size:27px;font-weight:700;letter-spacing:-.5px;color:#fff;line-height:1}
.page-tag{font-family:var(--mono);font-size:11px;color:var(--z600);letter-spacing:2px;text-transform:uppercase;margin-top:4px}

/* â”€â”€ GLASS CARD â”€â”€ */
.gc{background:var(--w5);border:1px solid var(--w10);border-radius:var(--rl);padding:20px 22px;backdrop-filter:blur(10px);position:relative;overflow:hidden}
.gc::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--w20),transparent)}
.card-lbl{font-family:var(--mono);font-size:11px;letter-spacing:2px;text-transform:uppercase;color:var(--z600);margin-bottom:12px}

/* â”€â”€ GRIDS â”€â”€ */
.g4{display:grid;grid-template-columns:repeat(4,1fr);gap:13px}
.g3{display:grid;grid-template-columns:repeat(3,1fr);gap:13px}
.g2{display:grid;grid-template-columns:repeat(2,1fr);gap:13px}
.gm{display:grid;grid-template-columns:1.7fr 1fr;gap:13px}
.mb4{margin-bottom:15px}.mt4{margin-top:14px}
.fbetween{display:flex;justify-content:space-between;align-items:center}
.fgap{display:flex;gap:9px;align-items:center;flex-wrap:wrap}

/* â”€â”€ STAT CARDS â”€â”€ */
.sc{background:var(--w5);border:1px solid var(--w10);border-radius:var(--rl);padding:17px 19px;position:relative;overflow:hidden;transition:all .2s}
.sc:hover{background:var(--w8);border-color:var(--w15)}
.sc-lbl{font-family:var(--mono);font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--z600);margin-bottom:8px}
.sc-val{font-size:30px;font-weight:700;letter-spacing:-1px;color:#fff;line-height:1}
.sc-unit{font-size:11px;color:var(--z500);margin-top:4px}
.sc-g .sc-val{color:var(--green)} .sc-r .sc-val{color:var(--red)}
.sc-y .sc-val{color:var(--yellow)} .sc-b .sc-val{color:var(--blue)}
.sc-g::after,.sc-r::after,.sc-y::after,.sc-b::after{content:'';position:absolute;top:0;left:0;right:0;height:2px}
.sc-g::after{background:linear-gradient(90deg,transparent,var(--green),transparent)}
.sc-r::after{background:linear-gradient(90deg,transparent,var(--red),transparent)}
.sc-y::after{background:linear-gradient(90deg,transparent,var(--yellow),transparent)}
.sc-b::after{background:linear-gradient(90deg,transparent,var(--blue),transparent)}

/* â”€â”€ IHB BUTTON â”€â”€ */
.ihb{position:relative;overflow:hidden;border-radius:var(--rf);border:1px solid var(--w15);background:var(--w8);padding:9px 20px;font-family:var(--mono);font-size:10px;letter-spacing:1px;cursor:pointer;color:var(--z200);text-transform:uppercase;white-space:nowrap;transition:border-color .2s}
.ihb:hover{border-color:var(--w25)}
.ihb-t{display:inline-block;transition:transform .28s,opacity .28s}
.ihb:hover .ihb-t{transform:translateX(34px);opacity:0}
.ihb-hc{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;gap:5px;transform:translateX(-34px);opacity:0;transition:transform .28s,opacity .28s;color:var(--z950);font-weight:700;z-index:2;font-family:var(--mono);font-size:10px;letter-spacing:1px;text-transform:uppercase}
.ihb:hover .ihb-hc{transform:translateX(0);opacity:1}
.ihb-b{position:absolute;left:18%;top:38%;width:10px;height:10px;border-radius:99px;background:#fff;transition:all .32s cubic-bezier(.4,0,.2,1);z-index:1}
.ihb:hover .ihb-b{left:0;top:0;width:100%;height:100%;border-radius:0}
.ihb-r{border-color:rgba(248,113,113,.3);color:var(--red)}.ihb-r .ihb-b{background:var(--red)}
.ihb-g{border-color:rgba(74,222,128,.3);color:var(--green)}.ihb-g .ihb-b{background:var(--green)}
.ihb-sm{padding:6px 13px;font-size:9px}

/* â”€â”€ FORMS â”€â”€ */
.fg{margin-bottom:13px}
.fl{display:block;font-family:var(--mono);font-size:11px;letter-spacing:2px;text-transform:uppercase;color:var(--z600);margin-bottom:7px}
.fi,.fs,.ft{width:100%;background:var(--w5);border:1px solid var(--w10);border-radius:9px;padding:10px 13px;color:#fff;font-family:var(--sans);font-size:15px;transition:border-color .18s,box-shadow .18s;outline:none}
.fi::placeholder,.ft::placeholder{color:var(--z700)}
.fi:focus,.fs:focus,.ft:focus{border-color:var(--w25);box-shadow:0 0 0 3px rgba(255,255,255,.04)}
.ft{resize:vertical;min-height:78px}.fs option{background:var(--z900);color:#fff}
input[type="file"]{display:none}

/* â”€â”€ TAGS â”€â”€ */
.tag{display:inline-block;font-family:var(--mono);font-size:9px;letter-spacing:1px;padding:2px 8px;border-radius:var(--rf);border:1px solid;text-transform:uppercase;white-space:nowrap}
.t-ph{color:var(--cyan);  border-color:rgba(34,211,238,.3);background:rgba(34,211,238,.07)}
.t-ch{color:var(--purple);border-color:rgba(192,132,252,.3);background:rgba(192,132,252,.07)}
.t-bi{color:var(--green); border-color:rgba(74,222,128,.3); background:rgba(74,222,128,.07)}
.t-ma{color:var(--yellow);border-color:rgba(251,191,36,.3); background:rgba(251,191,36,.07)}
.t-ge{color:var(--orange);border-color:rgba(251,146,60,.3); background:rgba(251,146,60,.07)}
.t-en{color:var(--red);   border-color:rgba(248,113,113,.3);background:rgba(248,113,113,.07)}
.t-ci{color:var(--blue);  border-color:rgba(96,165,250,.3); background:rgba(96,165,250,.07)}
.t-ok{color:var(--green); border-color:rgba(74,222,128,.3); background:rgba(74,222,128,.07)}
.t-ng{color:var(--red);   border-color:rgba(248,113,113,.3);background:rgba(248,113,113,.07)}
.t-wn{color:var(--yellow);border-color:rgba(251,191,36,.3); background:rgba(251,191,36,.07)}

/* â”€â”€ MODAL â”€â”€ */
.mo{display:none;position:fixed;inset:0;background:rgba(0,0,0,.72);backdrop-filter:blur(8px);z-index:1000;align-items:center;justify-content:center}
.mo.open{display:flex}
.mod{background:rgba(22,22,25,.96);border:1px solid var(--w10);border-radius:var(--rxl);padding:28px 28px 32px;width:510px;max-width:95vw;max-height:86vh;overflow-y:auto;position:relative;box-shadow:0 40px 80px rgba(0,0,0,.55),0 0 0 1px var(--w5);animation:fadeUp .18s ease}
.mod-t{font-size:18px;font-weight:600;color:#fff;margin-bottom:20px;letter-spacing:-.2px}
.mod-x{position:absolute;top:16px;right:16px;background:var(--w5);border:1px solid var(--w10);border-radius:6px;color:var(--z500);font-size:13px;cursor:pointer;width:26px;height:26px;display:flex;align-items:center;justify-content:center;transition:all .14s;line-height:1}
.mod-x:hover{background:rgba(248,113,113,.14);border-color:rgba(248,113,113,.3);color:var(--red)}

/* â”€â”€ TODO â”€â”€ */
.todo{display:flex;align-items:center;gap:9px;padding:8px 9px;border-radius:9px;transition:background .12s}
.todo:hover{background:var(--w5)}
.tcb{width:17px;height:17px;border:1.5px solid var(--w20);border-radius:5px;flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:all .18s;cursor:pointer}
.tcb.ck{background:#fff;border-color:#fff}
.tcb.ck::after{content:'âœ“';color:var(--z950);font-size:10px;font-weight:700}
.ttx{font-size:15px;flex:1;color:var(--z300)}.ttx.dn{text-decoration:line-through;color:var(--z700)}

/* â”€â”€ SUBJ BARS â”€â”€ */
.sbr{display:flex;align-items:center;gap:11px;padding:9px 0;border-bottom:1px solid var(--w5)}
.sbr:last-child{border-bottom:none}
.snm{width:30px;font-family:var(--mono);font-size:9px;letter-spacing:1px;color:var(--z600);flex-shrink:0}
.sbw{flex:1;background:var(--w5);border-radius:99px;height:5px;overflow:hidden}
.sbf{height:100%;border-radius:99px;transition:width .6s cubic-bezier(.4,0,.2,1)}
.spc{width:32px;font-size:11px;color:var(--z500);text-align:right;font-weight:500;flex-shrink:0}

/* â”€â”€ TIMER â”€â”€ */
.tdis{font-size:58px;font-weight:700;letter-spacing:-2px;text-align:center;padding:22px 0;background:linear-gradient(180deg,#fff 0%,rgba(255,255,255,.45) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;transition:all .3s}
.tdis.run{background:linear-gradient(180deg,var(--green) 0%,rgba(74,222,128,.4) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.tctl{display:flex;gap:9px;justify-content:center;flex-wrap:wrap}

/* â”€â”€ CHAPTERS â”€â”€ */
.chs{margin-bottom:14px}
.chh{display:flex;align-items:center;justify-content:space-between;padding:11px 15px;background:var(--w5);border:1px solid var(--w8);border-radius:var(--r);cursor:pointer;transition:all .14s;margin-bottom:3px}
.chh:hover{background:var(--w8);border-color:var(--w15)}
.chl{display:none;padding-left:9px}.chl.open{display:block}
.chi{display:flex;align-items:center;gap:9px;padding:7px 11px;border-radius:8px;transition:background .12s}
.chi:hover{background:var(--w5)}
.cst{width:19px;height:19px;border:1.5px solid var(--z700);border-radius:50%;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:9px;cursor:pointer;transition:all .18s}
.cst.not-started{color:var(--z700)}
.cst.fuzzy{background:rgba(251,191,36,.1);border-color:var(--yellow);color:var(--yellow)}
.cst.mastered{background:rgba(74,222,128,.1);border-color:var(--green);color:var(--green)}
.cnm{font-size:15px;flex:1;color:var(--z300)}
.cadd{background:none;border:1px dashed var(--w10);color:var(--z600);font-family:var(--mono);font-size:10px;padding:7px 11px;border-radius:8px;cursor:pointer;width:100%;transition:all .13s;text-align:left;margin-top:3px;letter-spacing:.5px}
.cadd:hover{border-color:var(--w20);color:var(--z400)}

/* â”€â”€ NOTES â”€â”€ */
.ngrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(245px,1fr));gap:13px}
.ncard{background:var(--w5);border:1px solid var(--w8);border-radius:var(--rl);padding:15px;cursor:pointer;transition:all .18s}
.ncard:hover{border-color:var(--w20);background:var(--w8);transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,.2)}
.nct{font-size:16px;font-weight:500;color:#fff;margin-bottom:4px}
.ncm{font-family:var(--mono);font-size:11px;color:var(--z700);letter-spacing:1px;margin-bottom:9px}
.ncp{font-size:14px;color:var(--z500);line-height:1.55}
.nth{width:100%;max-height:140px;object-fit:cover;border-radius:8px;margin-top:9px;border:1px solid var(--w8)}
.ndetail{display:none}.ndetail.open{display:block}
.nlist.hidden{display:none}

/* â”€â”€ WRONG Q â”€â”€ */
.wqc{background:var(--w5);border:1px solid var(--w8);border-left:2px solid var(--red);border-radius:var(--rl);padding:17px 19px;margin-bottom:11px;transition:all .18s;position:relative;overflow:hidden}
.wqc::before{content:'';position:absolute;top:0;right:0;width:180px;height:180px;background:radial-gradient(circle at top right,rgba(248,113,113,.04) 0%,transparent 70%);pointer-events:none}
.wqc:hover{border-color:rgba(248,113,113,.28);background:var(--w8)}
.wqc.mastered{border-left-color:var(--green);opacity:.5}
.wqc.mastered::before{background:radial-gradient(circle at top right,rgba(74,222,128,.04) 0%,transparent 70%)}
.wqh{display:flex;align-items:center;gap:6px;margin-bottom:11px;flex-wrap:wrap}
.wqq{font-size:16px;line-height:1.7;color:var(--z200);margin-bottom:9px}
.wqi{width:100%;max-height:210px;object-fit:contain;border-radius:8px;margin:9px 0;border:1px solid var(--w8);background:var(--w5);cursor:pointer}
.wqreason{margin-top:7px;padding:9px 13px;background:rgba(248,113,113,.05);border-radius:8px;font-size:14px;color:var(--z500);border-left:2px solid rgba(248,113,113,.35)}
.wqsol{margin-top:7px;padding:9px 13px;background:rgba(74,222,128,.04);border-radius:8px;font-size:14px;color:var(--z500);border-left:2px solid rgba(74,222,128,.35)}
.wqact{display:flex;gap:7px;margin-top:11px;flex-wrap:wrap}

/* WQ STATS */
.wqs4{display:grid;grid-template-columns:repeat(4,1fr);gap:11px;margin-bottom:18px}
.wqs{background:var(--w5);border:1px solid var(--w8);border-radius:var(--rl);padding:13px 15px}
.wqsl{font-family:var(--mono);font-size:9px;letter-spacing:2px;color:var(--z600);text-transform:uppercase;margin-bottom:5px}
.wqsv{font-size:22px;font-weight:700;letter-spacing:-.5px;color:#fff}

/* STARS */
.stars{display:flex;gap:5px;align-items:center}
.star{font-size:20px;cursor:pointer;color:var(--z700);transition:color .1s,transform .14s}
.star:hover,.star.on{color:var(--yellow);transform:scale(1.2)}

/* ERROR CHIPS */
.echips{display:flex;gap:7px;flex-wrap:wrap}
.ec{padding:5px 11px;border-radius:var(--rf);font-size:11px;font-family:var(--mono);letter-spacing:.5px;cursor:pointer;border:1px solid var(--w10);color:var(--z500);background:transparent;transition:all .13s}
.ec:hover{border-color:var(--w20);color:var(--z300)}
.ec.s-cl{background:rgba(251,191,36,.1);border-color:rgba(251,191,36,.45);color:var(--yellow)}
.ec.s-co{background:rgba(248,113,113,.1);border-color:rgba(248,113,113,.45);color:var(--red)}
.ec.s-fo{background:rgba(192,132,252,.1);border-color:rgba(192,132,252,.45);color:var(--purple)}
.ec.s-ca{background:rgba(34,211,238,.1);border-color:rgba(34,211,238,.45);color:var(--cyan)}
.ec.s-re{background:rgba(251,146,60,.1);border-color:rgba(251,146,60,.45);color:var(--orange)}
.ec.s-ot{background:rgba(161,161,170,.1);border-color:rgba(161,161,170,.45);color:var(--z400)}

/* REVIEW BADGES */
.rb{display:inline-flex;align-items:center;gap:4px;font-family:var(--mono);font-size:9px;padding:2px 8px;border-radius:var(--rf);border:1px solid;white-space:nowrap}
.rb-due{color:var(--red);border-color:rgba(248,113,113,.35);background:rgba(248,113,113,.07);animation:pulse 2s infinite}
.rb-soon{color:var(--yellow);border-color:rgba(251,191,36,.35);background:rgba(251,191,36,.07)}
.rb-ok{color:var(--green);border-color:rgba(74,222,128,.35);background:rgba(74,222,128,.07)}

/* MISC */
.div{height:1px;background:var(--w8);margin:16px 0}
.empty{text-align:center;padding:52px 20px;color:var(--z700)}
.eico{font-size:26px;margin-bottom:11px;opacity:.4}
.etxt{font-family:var(--mono);font-size:10px;letter-spacing:2px;color:var(--z700)}
.lbox{display:none;position:fixed;inset:0;background:rgba(0,0,0,.93);z-index:2000;align-items:center;justify-content:center;cursor:zoom-out;backdrop-filter:blur(4px)}
.lbox.open{display:flex}
.lbox img{max-width:92vw;max-height:92vh;border-radius:10px;box-shadow:0 0 80px rgba(0,0,0,.8)}
.leg{display:flex;gap:14px;flex-wrap:wrap;margin-bottom:13px}
.leg-i{display:flex;align-items:center;gap:6px;font-size:11px;color:var(--z500)}
.leg-d{width:8px;height:8px;border-radius:50%}

/* legacy fallback btns */
.btn{font-family:var(--mono);font-size:10px;letter-spacing:1px;padding:7px 15px;border-radius:var(--rf);cursor:pointer;transition:all .18s;border:1px solid;text-transform:uppercase}
.btn-primary{background:#fff;border-color:#fff;color:var(--z950);font-weight:700}.btn-primary:hover{background:var(--z200)}
.btn-ghost{background:var(--w5);border-color:var(--w15);color:var(--z300)}.btn-ghost:hover{background:var(--w10)}
.btn-danger{background:transparent;border-color:rgba(248,113,113,.3);color:var(--red)}.btn-danger:hover{background:rgba(248,113,113,.09)}
.btn-sm{padding:4px 9px;font-size:9px}

/* SEMESTER BAR */
#sem-bar{display:flex;align-items:center;gap:12px;padding:10px 34px;background:rgba(9,9,11,.6);border-bottom:1px solid var(--w8);backdrop-filter:blur(12px)}
.sem-lbl{font-family:var(--mono);font-size:10px;letter-spacing:2px;color:var(--z600);text-transform:uppercase;white-space:nowrap}
#sem-sel{background:var(--w8);border:1px solid var(--w15);border-radius:var(--rf);padding:6px 14px;color:#fff;font-family:var(--mono);font-size:12px;letter-spacing:1px;cursor:pointer;outline:none}
#sem-sel option{background:var(--z900)}

/* ADMIN PANEL */
#admin-panel{display:none;margin:6px 10px 10px;background:rgba(251,191,36,.05);border:1px solid rgba(251,191,36,.2);border-radius:var(--r);padding:12px 14px}
.adm-hd{font-family:var(--mono);font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--yellow);margin-bottom:10px}
.adm-row{display:flex;align-items:center;gap:7px;padding:5px 8px;background:var(--w5);border-radius:8px;margin-bottom:4px}
.adm-em{flex:1;font-family:var(--mono);font-size:10px;color:var(--z300);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.adm-badge{font-family:var(--mono);font-size:8px;padding:2px 6px;border-radius:99px;border:1px solid;flex-shrink:0}
.adm-master{color:var(--yellow);border-color:rgba(251,191,36,.4);background:rgba(251,191,36,.08)}
.adm-user{color:var(--z500);border-color:var(--w10)}
.adm-del{background:none;border:none;color:var(--z700);cursor:pointer;font-size:12px;padding:2px 5px;border-radius:4px;transition:all .13s;line-height:1}
.adm-del:hover{color:var(--red);background:rgba(248,113,113,.1)}
.adm-add{display:flex;gap:7px;margin-top:8px}
.adm-add .fi{padding:7px 10px;font-size:12px}

/* PDF */
.pdf-ov{display:none;position:fixed;inset:0;background:rgba(0,0,0,.88);z-index:2100;align-items:center;justify-content:center;backdrop-filter:blur(6px)}
.pdf-ov.open{display:flex}
.pdf-box{width:90vw;height:90vh;background:var(--z900);border:1px solid var(--w15);border-radius:var(--rxl);overflow:hidden;display:flex;flex-direction:column}
.pdf-topbar{display:flex;align-items:center;justify-content:space-between;padding:12px 18px;border-bottom:1px solid var(--w8);flex-shrink:0}
.pdf-title{font-size:14px;font-weight:500;color:#fff;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:75%}
.pdf-frame{flex:1;width:100%;border:none}
.pdf-chip{display:inline-flex;align-items:center;gap:7px;padding:8px 13px;background:var(--w5);border:1px solid var(--w10);border-radius:8px;margin-top:8px;cursor:pointer;transition:all .15s;color:var(--z400);font-size:13px;width:100%}
.pdf-chip:hover{border-color:var(--w20);background:var(--w8);color:#fff}
.pdf-chip-icon{font-size:20px}
.pdf-chip-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-family:var(--mono);font-size:11px}

</style>
</head>
<body>
<div class="bg-blob-1"></div>
<div class="bg-blob-2"></div>

<div id="sync-bar">
  <div class="sync-dot" id="sync-dot"></div>
  <span id="sync-label">Not connected</span>
</div>

<div id="login-screen">
  <div class="login-box">
    <div class="login-badge"><div class="pingdot"><span></span><span></span></div>CLOUD SYNC</div>
    <div class="login-title">STUDY</div>
    <div class="login-sub">STUDY OS Â· v6</div>
    <button class="btn-google" onclick="signInWithGoogle()">
      <svg width="18" height="18" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
      ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥
    </button>
    <div class="login-fine">è³‡æ–™åŠ å¯†å­˜æ–¼ Firebase Â· è·¨è£ç½®åŒæ­¥</div>
  </div>
</div>

<div class="app-shell" id="app-shell" style="display:none;">
  <nav class="sidebar">
    <div class="sidebar-logo"><div class="logo-word">STUDY</div><div class="logo-sub">Study OS v6</div></div>
    <div class="sidebar-user">
      <img id="user-avatar" class="user-avatar" src="" alt="">
      <span id="user-name" class="user-name"></span>
      <button class="btn-logout" onclick="signOut()" title="ç™»å‡º">â»</button>
    </div>
    <div class="sidebar-nav">
      <div class="nav-sec">Main</div>
      <div class="nav-item active" onclick="showPage('dashboard')"><span class="nav-icon">âŠ</span> Dashboard</div>
      <div class="nav-item" onclick="showPage('timer')"><span class="nav-icon">â—·</span> Study Timer</div>
      <div class="nav-sec">Academics</div>
      <div class="nav-item" onclick="showPage('progress')"><span class="nav-icon">â—ˆ</span> ç« ç¯€é€²åº¦</div>
      <div class="nav-item" onclick="showPage('notes')"><span class="nav-icon">â—»</span> ç­†è¨˜æœ¬</div>
      <div class="nav-item" onclick="showPage('wrongq')"><span class="nav-icon">âš </span> éŒ¯é¡Œæœ¬</div>
      <div class="nav-sec">Exams</div>
      <div class="nav-item" onclick="showPage('exams')"><span class="nav-icon">â—†</span> è€ƒè©¦å€’æ•¸</div>
    </div>
    <div id="admin-panel"><div class="adm-hd">âš™ å¸³è™Ÿç®¡ç†</div><div id="adm-list"></div><div class="adm-add"><input class="fi" id="adm-inp" placeholder="è¼¸å…¥ Gmail æ–°å¢æˆæ¬Š" onkeydown="if(event.key==='Enter')admAdd()"><button class="ihb ihb-sm" onclick="admAdd()"><div class="ihb-b"></div><span class="ihb-t">æ–°å¢</span><div class="ihb-hc">æ–°å¢ â†’</div></button></div></div>
  </nav>

  <main class="main-content">
    <div id="sem-bar"><span class="sem-lbl">&#x5B78;&#x671F;</span><select id="sem-sel" onchange="changeSem()"><option value="114-2">114 &#x4E0B;&#x5B78;&#x671F;</option><option value="114-1">114 &#x4E0A;&#x5B78;&#x671F;</option><option value="113-2">113 &#x4E0B;&#x5B78;&#x671F;</option><option value="113-1">113 &#x4E0A;&#x5B78;&#x671F;</option></select></div>

    <div id="page-dashboard" class="page active">
      <div class="page-header">
        <div><div class="page-title">Dashboard</div><div class="page-tag" id="today-date-label"></div></div>
      </div>
      <div class="g4 mb4">
        <div class="sc sc-g"><div class="sc-lbl">Today Study</div><div class="sc-val" id="dash-study-time">0</div><div class="sc-unit">åˆ†é˜</div></div>
        <div class="sc sc-b"><div class="sc-lbl">Next Exam</div><div class="sc-val" id="dash-next-exam">--</div><div class="sc-unit" id="dash-next-exam-name">å°šæœªè¨­å®š</div></div>
        <div class="sc sc-r"><div class="sc-lbl">Wrong Q</div><div class="sc-val" id="dash-wrong-count">0</div><div class="sc-unit">é¡Œå¾…è¤‡ç¿’</div></div>
        <div class="sc sc-y"><div class="sc-lbl">Overall</div><div class="sc-val" id="dash-overall-pct">0%</div><div class="sc-unit">ç« ç¯€æŒæ¡ç‡</div></div>
      </div>
      <div class="gm">
        <div class="gc">
          <div class="fbetween mb4">
            <div class="card-lbl">Today's Tasks</div>
            <button class="ihb ihb-sm" onclick="openAddTodo()"><div class="ihb-b"></div><span class="ihb-t">+ Add</span><div class="ihb-hc">+ Add â†’</div></button>
          </div>
          <div id="todo-list"></div>
          <div class="empty" id="todo-empty" style="display:none;"><div class="eico">â—»</div><div class="etxt">No tasks yet</div></div>
        </div>
        <div class="gc"><div class="card-lbl">Subject Overview</div><div id="dash-subject-overview"></div></div>
      </div>
    </div>

    <div id="page-timer" class="page">
      <div class="page-header"><div><div class="page-title">Study Timer</div><div class="page-tag">Focus Mode</div></div></div>
      <div class="g2">
        <div class="gc">
          <div class="card-lbl">Session Timer</div>
          <div class="tdis" id="timer-display">00:00:00</div>
          <div class="tctl">
            <button class="ihb" onclick="timerStart()"><div class="ihb-b"></div><span class="ihb-t">â–¶ Start</span><div class="ihb-hc">â–¶ Start â†’</div></button>
            <button class="ihb" onclick="timerPause()"><div class="ihb-b"></div><span class="ihb-t">â¸ Pause</span><div class="ihb-hc">â¸ Pause â†’</div></button>
            <button class="ihb ihb-r" onclick="timerReset()"><div class="ihb-b"></div><span class="ihb-t">â†º Reset</span><div class="ihb-hc">â†º Reset â†’</div></button>
          </div>
          <div class="mt4">
            <div class="fg"><label class="fl">ç§‘ç›®</label>
              <select class="fs" id="timer-subject">
                <option value="physics">ç‰©ç†</option><option value="chem">åŒ–å­¸</option><option value="bio">ç”Ÿç‰©</option>
                <option value="math">æ•¸å­¸</option><option value="geo">åœ°ç†</option><option value="eng">è‹±æ–‡</option><option value="chi">åœ‹æ–‡</option>
              </select>
            </div>
            <button class="ihb ihb-g" style="width:100%;justify-content:center;" onclick="saveSession()"><div class="ihb-b"></div><span class="ihb-t">âœ“ Log Session</span><div class="ihb-hc">âœ“ Log Session â†’</div></button>
          </div>
        </div>
        <div class="gc"><div class="card-lbl">Today's Log</div><div id="session-log"></div><div class="empty" id="session-empty"><div class="eico">â—·</div><div class="etxt">No sessions</div></div></div>
      </div>
    </div>

    <div id="page-progress" class="page">
      <div class="page-header"><div><div class="page-title">ç« ç¯€é€²åº¦</div><div class="page-tag">Chapter Tracker</div></div></div>
      <div class="leg"><div class="leg-i"><div class="leg-d" style="background:var(--z700)"></div>æœªé–‹å§‹</div><div class="leg-i"><div class="leg-d" style="background:var(--yellow)"></div>æ¨¡ç³Š</div><div class="leg-i"><div class="leg-d" style="background:var(--green)"></div>æŒæ¡</div></div>
      <div class="fgap mb4"><button class="ihb" onclick="openAddChapter()"><div class="ihb-b"></div><span class="ihb-t">+ æ–°å¢ç« ç¯€</span><div class="ihb-hc">+ æ–°å¢ç« ç¯€ â†’</div></button></div>
      <div id="chapter-tree"></div>
    </div>

    <div id="page-notes" class="page">
      <div class="page-header"><div><div class="page-title">ç­†è¨˜æœ¬</div><div class="page-tag">Notes</div></div></div>
      <div class="nlist" id="notes-list-view">
        <div class="fgap mb4">
          <button class="ihb" onclick="openAddNote()"><div class="ihb-b"></div><span class="ihb-t">+ æ–°å¢ç­†è¨˜</span><div class="ihb-hc">+ æ–°å¢ç­†è¨˜ â†’</div></button>
          <select class="fs" style="width:125px;" id="notes-filter" onchange="renderNotes()">
            <option value="all">å…¨éƒ¨ç§‘ç›®</option>
            <option value="physics">ç‰©ç†</option><option value="chem">åŒ–å­¸</option><option value="bio">ç”Ÿç‰©</option>
            <option value="math">æ•¸å­¸</option><option value="geo">åœ°ç†</option><option value="eng">è‹±æ–‡</option><option value="chi">åœ‹æ–‡</option>
          </select>
        </div>
        <div class="ngrid" id="notes-grid"></div>
        <div class="empty" id="notes-empty" style="display:none;"><div class="eico">â—»</div><div class="etxt">No notes yet</div></div>
      </div>
      <div class="ndetail" id="note-detail-view">
        <button class="ihb ihb-sm" onclick="closeNoteDetail()" style="margin-bottom:16px;"><div class="ihb-b"></div><span class="ihb-t">â† Back</span><div class="ihb-hc">â† Back â†’</div></button>
        <div class="gc">
          <div class="fbetween mb4">
            <div><div id="note-detail-title" style="font-size:18px;font-weight:600;color:#fff;margin-bottom:4px;"></div><div id="note-detail-meta" class="page-tag"></div></div>
            <button class="ihb ihb-r ihb-sm" onclick="deleteCurrentNote()"><div class="ihb-b"></div><span class="ihb-t">Delete</span><div class="ihb-hc">Delete â†’</div></button>
          </div>
          <div id="note-detail-tags" class="fgap mb4"></div>
          <img id="note-detail-img" class="nth" style="display:none;" alt=""><div id="note-detail-pdf"></div>
          <div class="div"></div>
          <div id="note-detail-summary" style="font-size:14px;line-height:1.9;white-space:pre-wrap;color:var(--z400);"></div>
          <div id="note-detail-questions" style="margin-top:15px;"></div>
        </div>
      </div>
    </div>

    <div id="page-wrongq" class="page">
      <div class="page-header"><div><div class="page-title">éŒ¯é¡Œæœ¬</div><div class="page-tag">Wrong Answer Bank</div></div></div>
      <div class="wqs4" id="wq-stats"></div>
      <div class="fgap mb4" style="flex-wrap:wrap;">
        <button class="ihb" onclick="openAddWrongQ()"><div class="ihb-b"></div><span class="ihb-t">+ æ–°å¢éŒ¯é¡Œ</span><div class="ihb-hc">+ æ–°å¢éŒ¯é¡Œ â†’</div></button>
        <select class="fs" style="width:115px;" id="wrongq-filter" onchange="renderWrongQ()"><option value="all">å…¨éƒ¨ç§‘ç›®</option><option value="physics">ç‰©ç†</option><option value="chem">åŒ–å­¸</option><option value="bio">ç”Ÿç‰©</option><option value="math">æ•¸å­¸</option><option value="geo">åœ°ç†</option><option value="eng">è‹±æ–‡</option><option value="chi">åœ‹æ–‡</option></select>
        <select class="fs" style="width:115px;" id="wrongq-type-filter" onchange="renderWrongQ()"><option value="all">å…¨éƒ¨é¡å‹</option><option value="careless">ç²—å¿ƒ</option><option value="concept">è§€å¿µéŒ¯èª¤</option><option value="formula">å…¬å¼è¨˜éŒ¯</option><option value="calc">å°è¨ˆç®—éŒ¯</option><option value="reading">é¡Œæ„çœ‹éŒ¯</option><option value="other">å…¶ä»–</option></select>
        <select class="fs" style="width:115px;" id="wrongq-difficulty-filter" onchange="renderWrongQ()"><option value="all">å…¨éƒ¨é›£åº¦</option><option value="1">â˜… 1æ˜Ÿ</option><option value="2">â˜…â˜… 2æ˜Ÿ</option><option value="3">â˜…â˜…â˜… 3æ˜Ÿ</option><option value="4">â˜…â˜…â˜…â˜… 4æ˜Ÿ</option><option value="5">â˜…â˜…â˜…â˜…â˜… 5æ˜Ÿ</option></select>
        <select class="fs" style="width:115px;" id="wrongq-status-filter" onchange="renderWrongQ()"><option value="all">å…¨éƒ¨ç‹€æ…‹</option><option value="pending">å¾…è¤‡ç¿’</option><option value="due">ä»Šæ—¥åˆ°æœŸ</option><option value="mastered">å·²æŒæ¡</option></select>
      </div>
      <div id="wrongq-list"></div>
      <div class="empty" id="wrongq-empty" style="display:none;"><div class="eico">âš </div><div class="etxt">No wrong answers â€” great job!</div></div>
    </div>

    <div id="page-exams" class="page">
      <div class="page-header"><div><div class="page-title">è€ƒè©¦å€’æ•¸</div><div class="page-tag">Exam Countdown</div></div></div>
      <div class="g2">
        <div class="gc">
          <div class="card-lbl">Add Exam</div>
          <div class="fg"><label class="fl">è€ƒè©¦åç¨±</label><input class="fi" id="exam-name-input" placeholder="e.g. æœŸä¸­è€ƒ"></div>
          <div class="fg"><label class="fl">è€ƒè©¦æ—¥æœŸ</label><input class="fi" type="date" id="exam-date-input"></div>
          <div class="fg"><label class="fl">ç§‘ç›®ç¯„åœï¼ˆé¸å¡«ï¼‰</label><input class="fi" id="exam-scope-input" placeholder="e.g. ç‰©ç† CH1â€“3"></div>
          <button class="ihb" style="width:100%;justify-content:center;" onclick="addExam()"><div class="ihb-b"></div><span class="ihb-t">+ Add Exam</span><div class="ihb-hc">+ Add Exam â†’</div></button>
        </div>
        <div class="gc"><div class="card-lbl">Upcoming Exams</div><div id="exam-list"></div><div class="empty" id="exam-empty" style="display:none;"><div class="eico">â—†</div><div class="etxt">No exams scheduled</div></div></div>
      </div>
    </div>

  </main>
</div>

<!-- MODALS -->
<div class="mo" id="modal-todo">
  <div class="mod">
    <div class="mod-t">Add Task</div><button class="mod-x" onclick="closeModal('modal-todo')">âœ•</button>
    <div class="fg"><label class="fl">ä»»å‹™å…§å®¹</label><input class="fi" id="todo-input" placeholder="e.g. ç‰©ç† CH3 ä¾‹é¡Œç·´ç¿’" onkeydown="if(event.key==='Enter')addTodo()"></div>
    <div class="fg"><label class="fl">ç§‘ç›®ï¼ˆé¸å¡«ï¼‰</label><select class="fs" id="todo-subject-input"><option value="">ç„¡</option><option value="physics">ç‰©ç†</option><option value="chem">åŒ–å­¸</option><option value="bio">ç”Ÿç‰©</option><option value="math">æ•¸å­¸</option><option value="geo">åœ°ç†</option><option value="eng">è‹±æ–‡</option><option value="chi">åœ‹æ–‡</option></select></div>
    <div class="fgap"><button class="ihb" onclick="addTodo()"><div class="ihb-b"></div><span class="ihb-t">Add</span><div class="ihb-hc">Add â†’</div></button><button class="ihb" onclick="closeModal('modal-todo')"><div class="ihb-b"></div><span class="ihb-t">Cancel</span><div class="ihb-hc">Cancel â†’</div></button></div>
  </div>
</div>

<div class="mo" id="modal-note">
  <div class="mod">
    <div class="mod-t">New Note</div><button class="mod-x" onclick="closeModal('modal-note')">âœ•</button>
    <div class="fg"><label class="fl">æ¨™é¡Œ</label><input class="fi" id="note-title-input" placeholder="e.g. ç‰©ç† CH3 ç‰›é “ç¬¬äºŒå®šå¾‹"></div>
    <div class="g2">
      <div class="fg"><label class="fl">ç§‘ç›®</label><select class="fs" id="note-subject-input"><option value="physics">ç‰©ç†</option><option value="chem">åŒ–å­¸</option><option value="bio">ç”Ÿç‰©</option><option value="math">æ•¸å­¸</option><option value="geo">åœ°ç†</option><option value="eng">è‹±æ–‡</option><option value="chi">åœ‹æ–‡</option></select></div>
      <div class="fg"><label class="fl">ç« ç¯€</label><input class="fi" id="note-chapter-input" placeholder="e.g. CH3"></div>
    </div>
    <div class="fg"><label class="fl">é‡é»æ‘˜è¦</label><textarea class="ft" id="note-summary-input" placeholder="è¨˜éŒ„é€™å ‚èª²çš„é‡é»æ¦‚å¿µ..."></textarea></div>
    <div class="fg"><label class="fl">ä¸æ‡‚çš„å•é¡Œ</label><textarea class="ft" id="note-questions-input" placeholder="ä»Šå¤©é‚„ä¸æ¸…æ¥šçš„åœ°æ–¹...ï¼ˆä¸€è¡Œä¸€å€‹å•é¡Œï¼‰" style="min-height:60px;"></textarea></div>
    <div class="fg"><label class="fl">é™„ä»¶ï¼ˆåœ–ç‰‡ / PDFï¼‰</label><div style="display:flex;gap:8px;flex-wrap:wrap;"><label class="btn btn-ghost btn-sm" style="display:inline-block;cursor:pointer;border-radius:99px;">ğŸ“· åœ–ç‰‡<input type="file" accept="image/*" onchange="handleNoteImage(this)"></label><label class="btn btn-ghost btn-sm" style="display:inline-block;cursor:pointer;border-radius:99px;">ğŸ“„ PDF<input type="file" accept="application/pdf" onchange="handleNotePDF(this)"></label></div><div id="note-img-preview" style="margin-top:8px;"></div></div>
    <div class="fgap"><button class="ihb" onclick="addNote()"><div class="ihb-b"></div><span class="ihb-t">Save Note</span><div class="ihb-hc">Save Note â†’</div></button><button class="ihb" onclick="closeModal('modal-note')"><div class="ihb-b"></div><span class="ihb-t">Cancel</span><div class="ihb-hc">Cancel â†’</div></button></div>
  </div>
</div>

<div class="mo" id="modal-wrongq">
  <div class="mod" style="width:570px;">
    <div class="mod-t">Log Wrong Answer</div><button class="mod-x" onclick="closeModal('modal-wrongq')">âœ•</button>
    <div class="g2">
      <div class="fg"><label class="fl">ç§‘ç›®</label><select class="fs" id="wq-subject-input"><option value="physics">ç‰©ç†</option><option value="chem">åŒ–å­¸</option><option value="bio">ç”Ÿç‰©</option><option value="math">æ•¸å­¸</option><option value="geo">åœ°ç†</option><option value="eng">è‹±æ–‡</option><option value="chi">åœ‹æ–‡</option></select></div>
      <div class="fg"><label class="fl">ä¾†æº</label><select class="fs" id="wq-source-input"><option value="èª²æœ¬ä¾‹é¡Œ">èª²æœ¬ä¾‹é¡Œ</option><option value="å­¸æ ¡è€ƒå·">å­¸æ ¡è€ƒå·</option><option value="åƒè€ƒæ›¸/è¬›ç¾©">åƒè€ƒæ›¸/è¬›ç¾©</option><option value="ç¶²è·¯é¡Œåº«">ç¶²è·¯é¡Œåº«</option><option value="æ¨¡æ“¬è€ƒ">æ¨¡æ“¬è€ƒ</option></select></div>
    </div>
    <div class="fg"><label class="fl">ç« ç¯€ï¼ˆé¸å¡«ï¼‰</label><input class="fi" id="wq-chapter-input" placeholder="e.g. CH3"></div>
    <div class="fg"><label class="fl">éŒ¯èª¤é¡å‹</label>
      <div class="echips">
        <div class="ec" data-type="careless" onclick="selectErrorType('careless')">ğŸ˜µ ç²—å¿ƒ</div>
        <div class="ec" data-type="concept"  onclick="selectErrorType('concept')">ğŸ§  è§€å¿µéŒ¯èª¤</div>
        <div class="ec" data-type="formula"  onclick="selectErrorType('formula')">ğŸ“ å…¬å¼è¨˜éŒ¯</div>
        <div class="ec" data-type="calc"     onclick="selectErrorType('calc')">ğŸ”¢ å°è¨ˆç®—éŒ¯</div>
        <div class="ec" data-type="reading"  onclick="selectErrorType('reading')">ğŸ“– é¡Œæ„çœ‹éŒ¯</div>
        <div class="ec" data-type="other"    onclick="selectErrorType('other')">â“ å…¶ä»–</div>
      </div>
    </div>
    <div class="fg"><label class="fl">é›£åº¦</label>
      <div class="stars">
        <span class="star" onclick="selectStar(1)">â˜…</span><span class="star" onclick="selectStar(2)">â˜…</span>
        <span class="star" onclick="selectStar(3)">â˜…</span><span class="star" onclick="selectStar(4)">â˜…</span>
        <span class="star" onclick="selectStar(5)">â˜…</span>
        <span style="font-family:var(--mono);font-size:9px;color:var(--z600);margin-left:9px;" id="wq-star-label">æœªé¸æ“‡</span>
      </div>
    </div>
    <div class="fg"><label class="fl">é¡Œç›®æè¿°</label><textarea class="ft" id="wq-question-input" placeholder="ç°¡è¿°é¡Œç›®å…§å®¹æˆ–è²¼ä¸Šé¡Œè™Ÿ..."></textarea></div>
    <div class="fg"><label class="fl">é™„ä»¶ï¼ˆåœ–ç‰‡ / PDFï¼Œå¯é¸ï¼‰</label><div style="display:flex;gap:8px;flex-wrap:wrap;"><label class="btn btn-ghost btn-sm" style="display:inline-block;cursor:pointer;border-radius:99px;">ğŸ“· åœ–ç‰‡<input type="file" accept="image/*" onchange="handleWQImage(this)"></label><label class="btn btn-ghost btn-sm" style="display:inline-block;cursor:pointer;border-radius:99px;">ğŸ“„ PDF<input type="file" accept="application/pdf" onchange="handleWQPDF(this)"></label></div><div id="wq-img-preview" style="margin-top:8px;"></div></div>
    <div class="fg"><label class="fl">âŒ éŒ¯èª¤åŸå› </label><textarea class="ft" id="wq-reason-input" placeholder="æˆ‘ç‚ºä»€éº¼ç­”éŒ¯ï¼Ÿ"></textarea></div>
    <div class="fg"><label class="fl">âœ… æ­£ç¢ºè§£æ³• / è§€å¿µ</label><textarea class="ft" id="wq-solution-input" placeholder="æ­£ç¢ºçš„è§£é¡Œæ€è·¯æ˜¯..."></textarea></div>
    <div class="fg"><label class="fl">ä¸‹æ¬¡è¤‡ç¿’æ—¥æœŸ</label>
      <input class="fi" type="date" id="wq-review-date-input">
      <div style="display:flex;gap:7px;margin-top:7px;flex-wrap:wrap;">
        <button class="btn btn-ghost btn-sm" onclick="setReviewDate(1)">æ˜å¤©</button>
        <button class="btn btn-ghost btn-sm" onclick="setReviewDate(3)">3å¤©å¾Œ</button>
        <button class="btn btn-ghost btn-sm" onclick="setReviewDate(7)">1é€±å¾Œ</button>
        <button class="btn btn-ghost btn-sm" onclick="setReviewDate(14)">2é€±å¾Œ</button>
      </div>
    </div>
    <div class="fgap">
      <button class="ihb ihb-g" onclick="addWrongQ()"><div class="ihb-b"></div><span class="ihb-t">Save</span><div class="ihb-hc">Save â†’</div></button>
      <button class="ihb" onclick="closeModal('modal-wrongq')"><div class="ihb-b"></div><span class="ihb-t">Cancel</span><div class="ihb-hc">Cancel â†’</div></button>
    </div>
  </div>
</div>

<div class="mo" id="modal-chapter">
  <div class="mod">
    <div class="mod-t">æ–°å¢ç« ç¯€</div><button class="mod-x" onclick="closeModal('modal-chapter')">âœ•</button>
    <div class="fg"><label class="fl">ç§‘ç›®</label><select class="fs" id="ch-subject-input"><option value="physics">ç‰©ç†</option><option value="chem">åŒ–å­¸</option><option value="bio">ç”Ÿç‰©</option><option value="math">æ•¸å­¸</option><option value="geo">åœ°ç†</option><option value="eng">è‹±æ–‡</option><option value="chi">åœ‹æ–‡</option></select></div>
    <div class="fg"><label class="fl">ç« ç¯€åç¨±</label><input class="fi" id="ch-name-input" placeholder="e.g. CH3 ç‰›é “é‹å‹•å®šå¾‹" onkeydown="if(event.key==='Enter')addChapter()"></div>
    <div class="fgap"><button class="ihb" onclick="addChapter()"><div class="ihb-b"></div><span class="ihb-t">Add</span><div class="ihb-hc">Add â†’</div></button><button class="ihb" onclick="closeModal('modal-chapter')"><div class="ihb-b"></div><span class="ihb-t">Cancel</span><div class="ihb-hc">Cancel â†’</div></button></div>
  </div>
</div>

<div class="pdf-ov" id="pdf-ov"><div class="pdf-box"><div class="pdf-topbar"><span class="pdf-title" id="pdf-title">PDF</span><button class="mod-x" style="position:static;" onclick="document.getElementById('pdf-ov').classList.remove('open')">&#x2715;</button></div><iframe class="pdf-frame" id="pdf-frame" src=""></iframe></div></div>
<div class="lbox" id="lightbox" onclick="this.classList.remove('open')"><img id="lightbox-img" src="" alt=""></div>

<script type="module">
import{initializeApp}from"https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
import{getAuth,GoogleAuthProvider,signInWithPopup,onAuthStateChanged,signOut as fbSignOut}from"https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
import{getFirestore,doc,setDoc,getDoc,collection,addDoc,getDocs,updateDoc,deleteDoc,query,onSnapshot,orderBy,arrayUnion,arrayRemove}from"https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

const fbCfg={apiKey:"AIzaSyAJGa2F3yzgA6DMGzCC6D3ARfS3H_sdiRU",authDomain:"apex-study-os.firebaseapp.com",projectId:"apex-study-os",storageBucket:"apex-study-os.firebasestorage.app",messagingSenderId:"722597129488",appId:"1:722597129488:web:3e97eade0769edffb48995"};
const app=initializeApp(fbCfg),auth=getAuth(app),db=getFirestore(app),prov=new GoogleAuthProvider();
const MASTER="s410315@hlhs.hlc.edu.tw";
let wl=[],masterUID=null,sem="114-2";
const SUBJ={physics:{n:"\u7269\u7406",c:"t-ph"},chem:{n:"\u5316\u5b78",c:"t-ch"},bio:{n:"\u751f\u7269",c:"t-bi"},math:{n:"\u6578\u5b78",c:"t-ma"},geo:{n:"\u5730\u7406",c:"t-ge"},eng:{n:"\u82f1\u6587",c:"t-en"},chi:{n:"\u570b\u6587",c:"t-ci"}};
const ETYPES={careless:{l:"\u7c97\u5fc3",col:"var(--yellow)"},concept:{l:"\u89c0\u5ff5\u932f\u8aa4",col:"var(--red)"},formula:{l:"\u516c\u5f0f\u8a18\u932f",col:"var(--purple)"},calc:{l:"\u5c0f\u8a08\u7b97\u932f",col:"var(--cyan)"},reading:{l:"\u984c\u610f\u770b\u932f",col:"var(--orange)"},other:{l:"\u5176\u4ed6",col:"var(--z400)"}};
let cu=null,noteImg=null,notePdf=null,noteId=null,tiInt=null,tiSec=0,tiRun=false;
let todos=[],notes=[],wrongs=[],chaps={},exams=[],sess=[];
let wqEType="",wqStars=0,wqImg=null,wqPdf=null;
// pdfStore: key -> File object (for ObjectURL preview this session)
const pdfStore=new Map();

const $=id=>document.getElementById(id);
function ss(s,l){$("sync-dot").className="sync-dot "+s;$("sync-label").textContent=l}

// â”€â”€ AUTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.signInWithGoogle=async()=>{try{await signInWithPopup(auth,prov)}catch(e){alert("\u767b\u5165\u5931\u6557\uff0c\u8acb\u518d\u8a66\u4e00\u6b21")}};
window.signOut=async()=>{await fbSignOut(auth);location.reload()};
onAuthStateChanged(auth,async u=>{
  if(u){
    cu=u;
    const wRef=doc(db,"config","whitelist");
    const wSnap=await getDoc(wRef);
    if(wSnap.exists()){wl=wSnap.data().emails||[];}
    else{wl=[MASTER,"benjaminshih1229@gmail.com","s410337@hlhs.hlc.edu.tw"];await setDoc(wRef,{emails:wl});}
    if(!wl.includes(u.email)){await fbSignOut(auth);alert("\u6b64\u5e33\u865f\u7121\u5b58\u53d6\u6b0a\u9650");return}
    const mr=doc(db,"accountMapping","masterUID");
    if(u.email===MASTER){masterUID=u.uid;await setDoc(mr,{uid:u.uid},{merge:true})}
    else{const s=await getDoc(mr);if(s.exists())masterUID=s.data().uid;else{alert("\u8acb\u5148\u7528\u4e3b\u5e33\u865f\u767b\u5165\u4e00\u6b21");await fbSignOut(auth);return}}
    $("login-screen").style.display="none";$("app-shell").style.display="flex";
    $("user-name").textContent=u.displayName||u.email;
    if(u.photoURL)$("user-avatar").src=u.photoURL;
    if(u.email===MASTER){$("admin-panel").style.display="block";renderAdm();}
    ss("syncing","Loading...");await load();ss("synced","Synced \u2713");
    renderDash();setupRT();
  }else{$("login-screen").style.display="flex";$("app-shell").style.display="none"}
});

// â”€â”€ FIRESTORE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function uid(){return masterUID||cu.uid}
function col(n){return collection(db,"users",uid(),"semesters",sem,n)}
async function load(){
  const[t,n,w,c,e,s]=await Promise.all([
    getDocs(query(col("todos"),orderBy("day","desc"))),
    getDocs(query(col("notes"),orderBy("date","desc"))),
    getDocs(query(col("wrongq"),orderBy("date","desc"))),
    getDocs(col("chapters")),getDocs(col("exams")),getDocs(col("sessions"))
  ]);
  todos=t.docs.map(d=>({id:d.id,...d.data()}));
  notes=n.docs.map(d=>({id:d.id,...d.data()}));
  wrongs=w.docs.map(d=>({id:d.id,...d.data()}));
  exams=e.docs.map(d=>({id:d.id,...d.data()}));
  sess=s.docs.map(d=>({id:d.id,...d.data()}));
  chaps={};c.docs.forEach(d=>{const x=d.data();if(!chaps[x.subject])chaps[x.subject]=[];chaps[x.subject].push({id:d.id,...x})});
}
function setupRT(){
  onSnapshot(col("todos"),s=>{todos=s.docs.map(d=>({id:d.id,...d.data()}));renderTodos();updateStats()});
  onSnapshot(col("wrongq"),s=>{wrongs=s.docs.map(d=>({id:d.id,...d.data()}));updateStats()});
  onSnapshot(col("chapters"),s=>{chaps={};s.docs.forEach(d=>{const x=d.data();if(!chaps[x.subject])chaps[x.subject]=[];chaps[x.subject].push({id:d.id,...x})});updateStats()});
}
async function fadd(cn,d){ss("syncing","Saving...");const r=await addDoc(col(cn),d);ss("synced","Synced \u2713");return r.id}
async function fup(cn,id,d){ss("syncing","Saving...");await updateDoc(doc(db,"users",uid(),"semesters",sem,cn,id),d);ss("synced","Synced \u2713")}
async function fdel(cn,id){ss("syncing","Deleting...");await deleteDoc(doc(db,"users",uid(),"semesters",sem,cn,id));ss("synced","Synced \u2713")}

// â”€â”€ SEMESTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.changeSem=async()=>{
  sem=$("sem-sel").value;ss("syncing","Loading...");await load();ss("synced","Synced \u2713");
  const pg=document.querySelector(".page.active");if(pg)showPage(pg.id.replace("page-",""));updateStats();
};

// â”€â”€ ADMIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAdm(){
  $("adm-list").innerHTML=wl.map(em=>{
    const b=em===MASTER;
    return `<div class="adm-row"><span class="adm-em">${em}</span><span class="adm-badge ${b?"adm-master":"adm-user"}">${b?"MASTER":"USER"}</span>${b?"":"<button class=\"adm-del\" data-em=\""+em+"\">\u00d7</button>"}</div>`;
  }).join("");
  $("adm-list").querySelectorAll(".adm-del").forEach(btn=>btn.addEventListener("click",()=>admDel(btn.dataset.em)));
}
window.admAdd=async()=>{
  const em=$("adm-inp").value.trim().toLowerCase();
  if(!em||!em.includes("@")){alert("\u8acb\u8f38\u5165\u6709\u6548 Gmail");return}
  if(wl.includes(em)){alert("\u6b64\u5e33\u865f\u5df2\u5b58\u5728");return}
  await updateDoc(doc(db,"config","whitelist"),{emails:arrayUnion(em)});
  wl.push(em);$("adm-inp").value="";renderAdm();
};
window.admDel=async em=>{
  if(!confirm("\u78ba\u5b9a\u79fb\u9664 "+em+" \u7684\u6388\u6b0a\uff1f"))return;
  await updateDoc(doc(db,"config","whitelist"),{emails:arrayRemove(em)});
  wl=wl.filter(x=>x!==em);renderAdm();
};

// â”€â”€ NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.showPage=id=>{
  document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
  document.querySelectorAll(".nav-item").forEach(n=>n.classList.remove("active"));
  $("page-"+id).classList.add("active");
  document.querySelectorAll(".nav-item").forEach(n=>{if(n.getAttribute("onclick")&&n.getAttribute("onclick").includes("'"+id+"'"))n.classList.add("active")});
  if(id==="dashboard")renderDash();if(id==="progress")renderChaps();if(id==="notes")renderNotes();
  if(id==="wrongq")renderWQ();if(id==="exams")renderExams();if(id==="timer")renderSessLog();
};
window.openModal=id=>$(id).classList.add("open");
window.closeModal=id=>$(id).classList.remove("open");
document.querySelectorAll(".mo").forEach(o=>o.addEventListener("click",e=>{if(e.target===o)o.classList.remove("open")}));
window.openAddTodo=()=>{$("todo-input").value="";openModal("modal-todo");setTimeout(()=>$("todo-input").focus(),50)};
window.openAddNote=()=>{noteImg=null;notePdf=null;$("note-img-preview").innerHTML="";["note-title-input","note-chapter-input","note-summary-input","note-questions-input"].forEach(id=>$(id).value="");openModal("modal-note")};
window.openAddChapter=()=>{$("ch-name-input").value="";openModal("modal-chapter")};
window.openAddChapterFor=s=>{$("ch-subject-input").value=s;openAddChapter()};

// â”€â”€ DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderDash(){
  $("today-date-label").textContent=new Date().toLocaleDateString("zh-TW",{weekday:"short",year:"numeric",month:"long",day:"numeric"});
  updateStats();renderTodos();
}
function updateStats(){
  const now=new Date(),today=now.toDateString();
  $("dash-study-time").textContent=sess.filter(s=>new Date(s.date).toDateString()===today).reduce((a,s)=>a+(s.minutes||0),0);
  const up=exams.filter(e=>new Date(e.date)>=now).sort((a,b)=>new Date(a.date)-new Date(b.date));
  if(up.length){$("dash-next-exam").textContent=Math.ceil((new Date(up[0].date)-now)/86400000);$("dash-next-exam-name").textContent=up[0].name}
  $("dash-wrong-count").textContent=wrongs.filter(q=>!q.mastered).length;
  const all=Object.values(chaps).flat(),m=all.filter(c=>c.status==="mastered").length;
  $("dash-overall-pct").textContent=(all.length?Math.round(m/all.length*100):0)+"%";
  $("dash-subject-overview").innerHTML=Object.keys(SUBJ).map(k=>{
    const c=chaps[k]||[],p=c.length?Math.round(c.filter(x=>x.status==="mastered").length/c.length*100):0;
    const cl=p>70?"var(--green)":p>30?"var(--yellow)":"var(--blue)";
    return`<div class="sbr"><div class="snm">${SUBJ[k].n}</div><div class="sbw"><div class="sbf" style="width:${p}%;background:${cl};"></div></div><div class="spc">${p}%</div></div>`;
  }).join("");
}

// â”€â”€ TODOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTodos(){
  const today=new Date().toDateString(),list=todos.filter(t=>t.day===today);
  const el=$("todo-list"),em=$("todo-empty");
  if(!list.length){el.innerHTML="";em.style.display="";return}
  em.style.display="none";
  el.innerHTML=list.map(t=>{
    const sb=t.subject&&SUBJ[t.subject]?`<span class="tag ${SUBJ[t.subject].c}">${SUBJ[t.subject].n}</span>`:"";
    return`<div class="todo"><div class="tcb ${t.done?"ck":""}" data-id="${t.id}"></div><div class="ttx ${t.done?"dn":""}">${t.text} ${sb}</div><button class="btn btn-danger btn-sm" data-id="${t.id}">\u00d7</button></div>`;
  }).join("");
  el.querySelectorAll(".tcb").forEach(b=>b.addEventListener("click",()=>toggleTodo(b.dataset.id)));
  el.querySelectorAll(".btn-danger").forEach(b=>b.addEventListener("click",()=>deleteTodo(b.dataset.id)));
}
window.addTodo=async()=>{const tx=$("todo-input").value.trim();if(!tx)return;await fadd("todos",{text:tx,subject:$("todo-subject-input").value,done:false,day:new Date().toDateString()});closeModal("modal-todo")};
window.toggleTodo=async id=>{const t=todos.find(t=>t.id===id);if(t)await fup("todos",id,{done:!t.done})};
window.deleteTodo=async id=>fdel("todos",id);

// â”€â”€ TIMER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.timerStart=()=>{if(tiRun)return;tiRun=true;$("timer-display").classList.add("run");tiInt=setInterval(()=>{tiSec++;updTi()},1000)};
window.timerPause=()=>{tiRun=false;clearInterval(tiInt);$("timer-display").classList.remove("run")};
window.timerReset=()=>{timerPause();tiSec=0;updTi()};
function updTi(){const h=Math.floor(tiSec/3600),m=Math.floor((tiSec%3600)/60),s=tiSec%60;$("timer-display").textContent=[h,m,s].map(n=>String(n).padStart(2,"0")).join(":")}
window.saveSession=async()=>{
  if(tiSec<60){alert("\u8acb\u81f3\u5c11\u8a08\u6642 1 \u5206\u9418");return}
  await fadd("sessions",{subject:$("timer-subject").value,minutes:Math.round(tiSec/60),date:new Date().toISOString()});
  timerReset();const sn=await getDocs(col("sessions"));sess=sn.docs.map(d=>({id:d.id,...d.data()}));renderSessLog();updateStats();
};
function renderSessLog(){
  const today=new Date().toDateString(),list=sess.filter(s=>new Date(s.date).toDateString()===today);
  const el=$("session-log"),em=$("session-empty");
  if(!list.length){el.innerHTML="";em.style.display="";return}
  em.style.display="none";
  el.innerHTML=list.map(s=>`<div class="sbr"><span class="tag ${SUBJ[s.subject]?.c||""}">${SUBJ[s.subject]?.n||""}</span><div style="flex:1;"></div><span style="font-size:20px;font-weight:700;color:var(--green);">${s.minutes}</span><span style="font-size:12px;color:var(--z600);margin-left:4px;">min</span></div>`).join("");
}

// â”€â”€ CHAPTERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderChaps(){
  $("chapter-tree").innerHTML=Object.keys(SUBJ).map(k=>{
    const c=chaps[k]||[],m=c.filter(x=>x.status==="mastered").length,pct=c.length?Math.round(m/c.length*100):0;
    const bc=pct>70?"var(--green)":pct>30?"var(--yellow)":"var(--blue)";
    const items=c.map(x=>`<div class="chi"><div class="cst ${x.status}" data-id="${x.id}" data-subj="${k}" data-cur="${x.status}">${x.status==="mastered"?"\u2713":x.status==="fuzzy"?"~":"\u25cb"}</div><div class="cnm">${x.name}</div><button class="btn btn-danger btn-sm" data-id="${x.id}">\u00d7</button></div>`).join("");
    return`<div class="chs"><div class="chh" onclick="this.nextElementSibling.classList.toggle('open')"><div class="fgap"><span class="tag ${SUBJ[k].c}">${SUBJ[k].n}</span><span style="font-size:13px;color:var(--z500);">${m}/${c.length} \u638c\u63e1</span></div><div style="display:flex;align-items:center;gap:11px;"><div style="width:85px;background:var(--w5);border-radius:99px;height:4px;"><div style="width:${pct}%;height:100%;border-radius:99px;background:${bc};"></div></div><span style="color:var(--z600);font-size:12px;">\u25be</span></div></div><div class="chl open">${items}<button class="cadd" data-subj="${k}">+ \u65b0\u589e\u7ae0\u7bc0</button></div></div>`;
  }).join("");
  $("chapter-tree").querySelectorAll(".cst").forEach(b=>b.addEventListener("click",()=>cycleChap(b.dataset.id,b.dataset.subj,b.dataset.cur)));
  $("chapter-tree").querySelectorAll(".chi .btn-danger").forEach(b=>b.addEventListener("click",()=>delChap(b.dataset.id)));
  $("chapter-tree").querySelectorAll(".cadd").forEach(b=>b.addEventListener("click",()=>openAddChapterFor(b.dataset.subj)));
}
window.cycleChap=async(id,k,cur)=>{
  const o=["not-started","fuzzy","mastered"];
  await fup("chapters",id,{status:o[(o.indexOf(cur)+1)%o.length]});
  const sn=await getDocs(col("chapters"));chaps={};
  sn.docs.forEach(d=>{const x=d.data();if(!chaps[x.subject])chaps[x.subject]=[];chaps[x.subject].push({id:d.id,...x})});
  renderChaps();updateStats();
};
window.delChap=async id=>{
  await fdel("chapters",id);
  const sn=await getDocs(col("chapters"));chaps={};
  sn.docs.forEach(d=>{const x=d.data();if(!chaps[x.subject])chaps[x.subject]=[];chaps[x.subject].push({id:d.id,...x})});
  renderChaps();
};
window.addChapter=async()=>{
  const nm=$("ch-name-input").value.trim();if(!nm)return;
  await fadd("chapters",{name:nm,subject:$("ch-subject-input").value,status:"not-started"});
  closeModal("modal-chapter");
  const sn=await getDocs(col("chapters"));chaps={};
  sn.docs.forEach(d=>{const x=d.data();if(!chaps[x.subject])chaps[x.subject]=[];chaps[x.subject].push({id:d.id,...x})});
  renderChaps();
};

// â”€â”€ PDF â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Use event delegation on the entire document for pdf-chip clicks
// Each chip gets data-pdfkey attribute
document.addEventListener("click",e=>{
  const chip=e.target.closest(".pdf-chip[data-pdfkey]");
  if(!chip)return;
  const key=chip.dataset.pdfkey;
  const file=pdfStore.get(key);
  if(!file){alert("PDF \u50c5\u5728\u672c\u6b21\u4e0a\u50b3\u5f8c\u53ef\u9810\u89bd\uff0c\u91cd\u65b0\u958b\u555f\u9801\u9762\u5f8c\u8acb\u91cd\u65b0\u4e0a\u50b3");return}
  const url=URL.createObjectURL(file);
  $("pdf-title").textContent=file.name;
  $("pdf-frame").src=url;
  $("pdf-ov").classList.add("open");
});
$("pdf-ov").addEventListener("click",e=>{if(e.target===$("pdf-ov"))$("pdf-ov").classList.remove("open")});

function makePdfChip(key,name){
  const d=document.createElement("div");
  d.className="pdf-chip";d.dataset.pdfkey=key;
  d.innerHTML=`<span class="pdf-chip-icon">\ud83d\udcc4</span><span class="pdf-chip-name">${name}</span><span style="font-size:12px;color:var(--z600);">\u9ede\u64ca\u9810\u89bd</span>`;
  return d;
}

// â”€â”€ NOTES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.handleNoteImage=inp=>{
  const f=inp.files[0];if(!f)return;notePdf=null;
  const r=new FileReader();
  r.onload=e=>{noteImg=e.target.result;$("note-img-preview").innerHTML=`<img src="${noteImg}" style="max-width:100%;max-height:120px;border-radius:8px;border:1px solid var(--w10);">`};
  r.readAsDataURL(f);
};
window.handleNotePDF=inp=>{
  const f=inp.files[0];if(!f)return;
  noteImg=null;notePdf={name:f.name,size:f.size};
  pdfStore.set("note_tmp",f);
  const prev=$("note-img-preview");prev.innerHTML="";
  prev.appendChild(makePdfChip("note_tmp",f.name));
};
window.addNote=async()=>{
  const t=$("note-title-input").value.trim();if(!t)return;
  const pMeta=notePdf?{name:notePdf.name,size:notePdf.size}:null;
  const nid=await fadd("notes",{title:t,subject:$("note-subject-input").value,chapter:$("note-chapter-input").value.trim(),summary:$("note-summary-input").value.trim(),questions:$("note-questions-input").value.trim(),image:noteImg||null,pdf:pMeta,date:new Date().toISOString()});
  if(pdfStore.has("note_tmp"))pdfStore.set("nd_"+nid,pdfStore.get("note_tmp"));
  noteImg=null;notePdf=null;
  closeModal("modal-note");
  const sn=await getDocs(query(col("notes"),orderBy("date","desc")));notes=sn.docs.map(d=>({id:d.id,...d.data()}));renderNotes();
};
function renderNotes(){
  const f=$("notes-filter").value,fl=f==="all"?notes:notes.filter(n=>n.subject===f);
  const g=$("notes-grid"),em=$("notes-empty");
  if(!fl.length){g.innerHTML="";em.style.display="";return}
  em.style.display="none";
  g.innerHTML=fl.map(n=>{
    const pT=n.pdf?`<span class="tag" style="color:var(--blue);border-color:rgba(96,165,250,.3);background:rgba(96,165,250,.07);">\ud83d\udcc4 PDF</span>`:"";
    const pv=n.summary?`<div class="ncp">${n.summary.slice(0,75)}${n.summary.length>75?"...":""}</div>`:"";
    const im=n.image?`<img src="${n.image}" class="nth" alt="">`:"";
    return`<div class="ncard" data-id="${n.id}"><div class="nct">${n.title}</div><div class="ncm">${new Date(n.date).toLocaleDateString("zh-TW")}${n.chapter?" \u00b7 "+n.chapter:""}</div><div class="fgap" style="margin-bottom:7px;"><span class="tag ${SUBJ[n.subject].c}">${SUBJ[n.subject].n}</span>${pT}</div>${pv}${im}</div>`;
  }).join("");
  $("notes-grid").querySelectorAll(".ncard").forEach(c=>c.addEventListener("click",()=>openNote(c.dataset.id)));
}
window.openNote=id=>{
  const n=notes.find(n=>n.id===id);if(!n)return;noteId=id;
  $("note-detail-title").textContent=n.title;
  $("note-detail-meta").textContent=new Date(n.date).toLocaleDateString("zh-TW")+(n.chapter?" \u00b7 "+n.chapter:"");
  $("note-detail-tags").innerHTML=`<span class="tag ${SUBJ[n.subject].c}">${SUBJ[n.subject].n}</span>`;
  const img=$("note-detail-img");
  if(n.image){img.src=n.image;img.style.display=""}else img.style.display="none";
  const pdfEl=$("note-detail-pdf");pdfEl.innerHTML="";
  if(n.pdf){pdfEl.appendChild(makePdfChip("nd_"+n.id,n.pdf.name))}
  $("note-detail-summary").textContent=n.summary||"(\u7121\u6458\u8981)";
  const qs=n.questions?"<div style=\"font-family:var(--mono);font-size:10px;letter-spacing:2px;color:var(--z600);margin-bottom:7px;\">\u2753 \u5f85\u89e3\u554f\u984c</div>"+n.questions.split("\n").filter(Boolean).map(q=>`<div style="padding:8px 12px;background:rgba(251,191,36,.05);border-left:2px solid rgba(251,191,36,.35);margin-bottom:6px;font-size:14px;border-radius:7px;color:var(--z400);">${q}</div>`).join(""):"";
  $("note-detail-questions").innerHTML=qs;
  $("notes-list-view").classList.add("hidden");$("note-detail-view").classList.add("open");
};
window.closeNoteDetail=()=>{$("note-detail-view").classList.remove("open");$("notes-list-view").classList.remove("hidden")};
window.deleteCurrentNote=async()=>{
  if(!noteId||!confirm("\u78ba\u5b9a\u522a\u9664\uff1f"))return;
  await fdel("notes",noteId);
  const sn=await getDocs(query(col("notes"),orderBy("date","desc")));notes=sn.docs.map(d=>({id:d.id,...d.data()}));
  closeNoteDetail();renderNotes();
};

// â”€â”€ WRONG Q â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.selectErrorType=t=>{wqEType=t;document.querySelectorAll(".ec").forEach(c=>{c.className="ec";if(c.dataset.type===t)c.classList.add("s-"+t.slice(0,2))})};
window.selectStar=n=>{wqStars=n;const lb=["","\u7c21\u55ae","\u666e\u901a","\u4e2d\u7b49","\u56f0\u96e3","\u5730\u7344"];document.querySelectorAll(".star").forEach((s,i)=>s.classList.toggle("on",i<n));$("wq-star-label").textContent=lb[n]||"\u672a\u9078\u64c7"};
window.setReviewDate=d=>{const x=new Date();x.setDate(x.getDate()+d);$("wq-review-date-input").value=x.toISOString().slice(0,10)};
window.handleWQImage=inp=>{
  const f=inp.files[0];if(!f)return;wqPdf=null;
  const r=new FileReader();
  r.onload=e=>{wqImg=e.target.result;$("wq-img-preview").innerHTML=`<img src="${wqImg}" style="max-width:100%;max-height:130px;border-radius:8px;border:1px solid var(--w10);">`};
  r.readAsDataURL(f);
};
window.handleWQPDF=inp=>{
  const f=inp.files[0];if(!f)return;
  wqImg=null;wqPdf={name:f.name,size:f.size};
  pdfStore.set("wq_tmp",f);
  const prev=$("wq-img-preview");prev.innerHTML="";
  prev.appendChild(makePdfChip("wq_tmp",f.name));
};
window.openLightbox=src=>{$("lightbox-img").src=src;$("lightbox").classList.add("open")};
window.openAddWrongQ=()=>{
  wqEType="";wqStars=0;wqImg=null;wqPdf=null;
  document.querySelectorAll(".ec").forEach(c=>c.className="ec");
  document.querySelectorAll(".star").forEach(s=>s.classList.remove("on"));
  $("wq-img-preview").innerHTML="";
  ["wq-question-input","wq-reason-input","wq-solution-input","wq-chapter-input","wq-review-date-input"].forEach(id=>$(id).value="");
  openModal("modal-wrongq");
};
window.addWrongQ=async()=>{
  const q=$("wq-question-input").value.trim();if(!q){alert("\u8acb\u586b\u5165\u984c\u76ee\u63cf\u8ff0");return}
  const pMeta=wqPdf?{name:wqPdf.name,size:wqPdf.size}:null;
  const wid=await fadd("wrongq",{subject:$("wq-subject-input").value,source:$("wq-source-input").value,chapter:$("wq-chapter-input").value.trim(),errorType:wqEType,difficulty:wqStars,question:q,image:wqImg||null,pdf:pMeta,reason:$("wq-reason-input").value.trim(),solution:$("wq-solution-input").value.trim(),reviewDate:$("wq-review-date-input").value||null,mastered:false,date:new Date().toISOString()});
  if(pdfStore.has("wq_tmp"))pdfStore.set("wq_"+wid,pdfStore.get("wq_tmp"));
  wqEType="";wqStars=0;wqImg=null;wqPdf=null;
  document.querySelectorAll(".ec").forEach(c=>c.className="ec");
  document.querySelectorAll(".star").forEach(s=>s.classList.remove("on"));
  $("wq-img-preview").innerHTML="";
  ["wq-question-input","wq-reason-input","wq-solution-input","wq-chapter-input","wq-review-date-input"].forEach(id=>$(id).value="");
  closeModal("modal-wrongq");
  const sn=await getDocs(query(col("wrongq"),orderBy("date","desc")));wrongs=sn.docs.map(d=>({id:d.id,...d.data()}));
  renderWQ();updateStats();
};

function revBadge(d){
  if(!d)return"";const now=new Date();now.setHours(0,0,0,0);
  const rd=new Date(d);rd.setHours(0,0,0,0);const diff=Math.ceil((rd-now)/86400000);
  if(diff<=0)return`<span class="rb rb-due">\u4eca\u65e5\u8907\u7fd2</span>`;
  if(diff<=3)return`<span class="rb rb-soon">${diff}\u5929\u5f8c</span>`;
  return`<span class="rb rb-ok">${diff}\u5929\u5f8c</span>`;
}
function stars(n){return n?"\u2605".repeat(n)+"\u2606".repeat(5-n):""}
function renderWQStats(){
  const tot=wrongs.length,m=wrongs.filter(q=>q.mastered).length,acc=tot?Math.round(m/tot*100):0;
  const tc={};wrongs.forEach(q=>{if(q.errorType)tc[q.errorType]=(tc[q.errorType]||0)+1});
  const top=Object.entries(tc).sort((a,b)=>b[1]-a[1])[0];
  const now=new Date();now.setHours(0,0,0,0);
  const due=wrongs.filter(q=>{if(!q.reviewDate||q.mastered)return false;const rd=new Date(q.reviewDate);rd.setHours(0,0,0,0);return rd<=now}).length;
  $("wq-stats").innerHTML=`<div class="wqs"><div class="wqsl">Total Wrong</div><div class="wqsv">${tot}</div></div><div class="wqs"><div class="wqsl">Mastery Rate</div><div class="wqsv" style="color:${acc>60?"var(--green)":acc>30?"var(--yellow)":"var(--red)"}">${acc}%</div></div><div class="wqs"><div class="wqsl">Due Today</div><div class="wqsv" style="color:${due>0?"var(--red)":"var(--green)"}">${due}</div></div><div class="wqs"><div class="wqsl">Top Error</div><div style="font-size:13px;margin-top:4px;color:var(--z500);">${top?ETYPES[top[0]].l||top[0]:"\u2014"}</div></div>`;
}
function renderWQ(){
  renderWQStats();
  const sf=$("wrongq-filter").value,tf=$("wrongq-type-filter").value,df=$("wrongq-difficulty-filter").value,stf=$("wrongq-status-filter").value;
  const now=new Date();now.setHours(0,0,0,0);
  let fl=wrongs.slice();
  if(sf!=="all")fl=fl.filter(q=>q.subject===sf);
  if(tf!=="all")fl=fl.filter(q=>q.errorType===tf);
  if(df!=="all")fl=fl.filter(q=>String(q.difficulty)===df);
  if(stf==="pending")fl=fl.filter(q=>!q.mastered);
  if(stf==="mastered")fl=fl.filter(q=>q.mastered);
  if(stf==="due")fl=fl.filter(q=>{if(!q.reviewDate||q.mastered)return false;const rd=new Date(q.reviewDate);rd.setHours(0,0,0,0);return rd<=now});
  const el=$("wrongq-list"),em=$("wrongq-empty");
  if(!fl.length){el.innerHTML="";em.style.display="";return}em.style.display="none";
  el.innerHTML="";
  fl.forEach(q=>{
    const et=q.errorType?ETYPES[q.errorType]:null;
    const etT=et?`<span class="tag" style="color:${et.col};border-color:${et.col}38;background:${et.col}10;">${et.l}</span>`:"";
    const chT=q.chapter?`<span class="tag" style="color:var(--z500);border-color:var(--w10);">${q.chapter}</span>`:"";
    const stH=q.difficulty?`<span style="color:var(--yellow);font-size:13px;">${stars(q.difficulty)}</span>`:"";
    const rH=q.reason?`<div class="wqreason">\u932f\u8aa4\u539f\u56e0\uff1a${q.reason}</div>`:"";
    const sH=q.solution?`<div class="wqsol">\u6b63\u78ba\u89e3\u6cd5\uff1a${q.solution}</div>`:"";
    const div=document.createElement("div");
    div.className="wqc "+(q.mastered?"mastered":"");
    div.innerHTML=`<div class="wqh"><span class="tag ${SUBJ[q.subject].c}">${SUBJ[q.subject].n}</span>${chT}<span class="tag" style="color:var(--z500);border-color:var(--w10);">${q.source}</span>${etT}${stH}${revBadge(q.reviewDate)}<span class="tag ${q.mastered?"t-ok":"t-ng"}" style="margin-left:auto;">${q.mastered?"MASTERED":"PENDING"}</span><span style="font-family:var(--mono);font-size:9px;color:var(--z600);">${new Date(q.date).toLocaleDateString("zh-TW")}</span></div><div class="wqq">${q.question}</div>${rH}${sH}<div class="wqact"><button class="ihb ${q.mastered?"":"ihb-g"} ihb-sm" data-id="${q.id}" data-cur="${q.mastered}"><div class="ihb-b"></div><span class="ihb-t">${q.mastered?"\u21a9 \u91cd\u7df4":"\u2713 \u5df2\u638c\u63e1"}</span><div class="ihb-hc">${q.mastered?"\u21a9 \u91cd\u7df4":"\u2713 \u5df2\u638c\u63e1"} \u2192</div></button><button class="ihb ihb-r ihb-sm del-wq" data-id="${q.id}"><div class="ihb-b"></div><span class="ihb-t">\u00d7 \u522a\u9664</span><div class="ihb-hc">\u00d7 \u522a\u9664 \u2192</div></button></div>`;
    // image
    if(q.image){const img=document.createElement("img");img.className="wqi";img.src=q.image;img.alt="";img.addEventListener("click",()=>openLightbox(q.image));div.querySelector(".wqq").after(img)}
    // pdf chip
    if(q.pdf){const chip=makePdfChip("wq_"+q.id,q.pdf.name);div.querySelector(".wqq").after(chip)}
    div.querySelector(".ihb:not(.del-wq)").addEventListener("click",()=>toggleWQ(q.id,q.mastered));
    div.querySelector(".del-wq").addEventListener("click",()=>delWQ(q.id));
    el.appendChild(div);
  });
}
window.toggleWQ=async(id,cur)=>{
  await fup("wrongq",id,{mastered:!cur});
  const sn=await getDocs(query(col("wrongq"),orderBy("date","desc")));wrongs=sn.docs.map(d=>({id:d.id,...d.data()}));
  renderWQ();updateStats();
};
window.delWQ=async id=>{
  if(!confirm("\u78ba\u5b9a\u522a\u9664\u9019\u984c\uff1f"))return;
  await fdel("wrongq",id);wrongs=wrongs.filter(q=>q.id!==id);renderWQ();updateStats();
};

// â”€â”€ EXAMS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addExam=async()=>{
  const nm=$("exam-name-input").value.trim(),dt=$("exam-date-input").value;
  if(!nm||!dt){alert("\u8acb\u586b\u5165\u540d\u7a31\u548c\u65e5\u671f");return}
  await fadd("exams",{name:nm,date:dt,scope:$("exam-scope-input").value.trim()});
  ["exam-name-input","exam-date-input","exam-scope-input"].forEach(id=>$(id).value="");
  const sn=await getDocs(col("exams"));exams=sn.docs.map(d=>({id:d.id,...d.data()}));renderExams();updateStats();
};
function renderExams(){
  const now=new Date(),s=[...exams].sort((a,b)=>new Date(a.date)-new Date(b.date));
  const el=$("exam-list"),em=$("exam-empty");
  if(!s.length){el.innerHTML="";em.style.display="";return}em.style.display="none";
  el.innerHTML="";
  s.forEach(e=>{
    const d=Math.ceil((new Date(e.date)-now)/86400000),p=d<0;
    const cl=p?"var(--z600)":d<=7?"var(--red)":d<=30?"var(--yellow)":"var(--green)";
    const div=document.createElement("div");
    div.style.cssText="padding:13px 15px;background:var(--w5);border:1px solid var(--w8);border-radius:var(--r);margin-bottom:9px;";
    div.innerHTML=`<div class="fbetween"><div><div style="font-size:15px;font-weight:500;color:#fff;margin-bottom:3px;">${e.name}</div><div style="font-family:var(--mono);font-size:10px;color:var(--z600);">${e.date}${e.scope?" \u00b7 "+e.scope:""}</div></div><div style="text-align:right;"><div style="font-size:28px;font-weight:700;color:${cl};letter-spacing:-1px;line-height:1;">${p?"DONE":d}</div><div style="font-family:var(--mono);font-size:9px;color:var(--z600);">${p?"":"days left"}</div></div></div><button class="ihb ihb-r ihb-sm" style="margin-top:9px;"><div class="ihb-b"></div><span class="ihb-t">\u00d7 \u522a\u9664</span><div class="ihb-hc">\u00d7 \u522a\u9664 \u2192</div></button>`;
    div.querySelector(".ihb").addEventListener("click",()=>delExam(e.id));
    el.appendChild(div);
  });
}
window.delExam=async id=>{await fdel("exams",id);exams=exams.filter(e=>e.id!==id);renderExams();updateStats()};

updTi();

</script>
</body>
</html>
